<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Vendas - Miplace Dompedro</title>
    
    <!-- Fonte Inter & Space Grotesk -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Fonte Mono para Recibo -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Configurações do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['Inter', 'sans-serif'],
                        display: ['"Space Grotesk"', 'sans-serif'],
                        mono: ['"Share Tech Mono"', 'monospace'],
                        receipt: ['"Space Mono"', 'monospace']
                    },
                    colors: {
                        odoo: { 
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155'
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideInRight: {
                            '0%': { opacity: '0', transform: 'translateX(20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    },
                    boxShadow: {
                        'glass': '0 4px 30px rgba(0, 0, 0, 0.1)',
                        'neon': '0 0 5px theme("colors.odoo.400"), 0 0 20px theme("colors.odoo.300")',
                    }
                }
            }
        }
    </script>

    <!-- FIREBASE SETUP -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCRqxsdvfjxEqknWEyeoswxweELL1ORl9o",
        authDomain: "miplace-dompedro-sales-control.firebaseapp.com",
        projectId: "miplace-dompedro-sales-control",
        storageBucket: "miplace-dompedro-sales-control.firebasestorage.app",
        messagingSenderId: "404194209741",
        appId: "1:404194209741:web:7d732e235a2344c2011e84",
        measurementId: "G-ZEJSPSMTP0"
      };

      if (!firebase.apps.length) {
          firebase.initializeApp(firebaseConfig);
      } else {
          firebase.app();
      }
      
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Persistência Offline
      db.enablePersistence({ synchronizeTabs: true }).catch(err => {
          if (err.code == 'failed-precondition') {
              console.log('Múltiplas abas abertas, persistência desabilitada nesta aba.');
          } else if (err.code == 'unimplemented') {
              console.log('Browser não suporta persistência.');
          }
      });
      
      console.log("Firebase conectado:", firebaseConfig.projectId);
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { 
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, rgba(14, 165, 233, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(124, 58, 237, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 40px 40px;
            background-image: 
                linear-gradient(to right, rgba(0,0,0,0.02) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0,0,0,0.02) 1px, transparent 1px);
        }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        input, select { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        input:focus, select:focus { transform: translateY(-1px); box-shadow: 0 10px 25px -5px rgba(14, 165, 233, 0.15), 0 8px 10px -6px rgba(14, 165, 233, 0.1); }
        input[type=number] { appearance: textfield; -moz-appearance: textfield; }
        input::-webkit-calendar-picker-indicator { opacity: 0.5; cursor: pointer; transition: opacity 0.2s; }
        input::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; transition: background 0.3s; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .receipt-paper { background-color: #ffffff; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; }
        .active-scale:active { transform: scale(0.96); }

        @media print {
            @page { margin: 5mm; size: auto; }
            .no-print { display: none !important; }
            body { background: white !important; margin: 0 !important; padding: 0 !important; font-size: 10px !important; }
            body:not(.receipt-open) .max-w-5xl { max-width: 100% !important; margin: 0 !important; padding: 0 !important; }
            body:not(.receipt-open) .bg-white { box-shadow: none !important; border: 1px solid #eee !important; border-radius: 0 !important; }
            body:not(.receipt-open) .overflow-x-auto { overflow: visible !important; }
            body:not(.receipt-open) table { width: 100% !important; table-layout: fixed !important; border-collapse: collapse !important; }
            body:not(.receipt-open) tr { page-break-inside: avoid !important; }
            body:not(.receipt-open) td, body:not(.receipt-open) th { padding: 4px !important; word-wrap: break-word !important; white-space: normal !important; vertical-align: top !important; }
            .print-col-cliente { width: 20% !important; }
            .print-col-itens { width: 35% !important; }
            .print-col-vendedor { width: 10% !important; }
            .print-col-pagamento { width: 20% !important; }
            .print-col-total { width: 15% !important; }
            body.receipt-open #root > div > div:not(.receipt-modal-wrapper) { display: none !important; }
            .receipt-modal-wrapper { position: fixed !important; top: 0; left: 0; width: 100%; height: 100%; background: white !important; padding: 0 !important; display: flex !important; align-items: flex-start !important; justify-content: center !important; z-index: 9999 !important; }
            .receipt-modal-content { box-shadow: none !important; width: 100% !important; max-width: 80mm !important; position: static !important; margin: 0 auto !important; }
            .receipt-paper { box-shadow: none !important; border: none !important; width: 100% !important; padding: 0 !important; border-radius: 0 !important; }
            .receipt-paper::after, .receipt-actions-bar { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="text-slate-600 antialiased selection:bg-odoo-200 selection:text-odoo-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ path, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} dangerouslySetInnerHTML={{ __html: path }} />
        );

        const Icons = {
            Plus: (props) => <Icon {...props} path='<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>' />,
            Edit: (props) => <Icon {...props} path='<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>' />,
            Trash2: (props) => <Icon {...props} path='<polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line>' />,
            Settings: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1-2-2v-.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>' />,
            Calendar: (props) => <Icon {...props} path='<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>' />,
            Store: (props) => <Icon {...props} path='<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>' />,
            Printer: (props) => <Icon {...props} path='<polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect>' />,
            Receipt: (props) => <Icon {...props} path='<path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1-2-1Z"></path><path d="M16 8h-8"></path><path d="M16 12h-8"></path><path d="M16 16h-8"></path>' />,
            Check: (props) => <Icon {...props} path='<polyline points="20 6 9 17 4 12"></polyline>' />,
            X: (props) => <Icon {...props} path='<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>' />,
            AlertCircle: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>' />,
            Save: (props) => <Icon {...props} path='<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline>' />,
            Upload: (props) => <Icon {...props} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line>' />,
            Download: (props) => <Icon {...props} path='<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>' />,
            Search: (props) => <Icon {...props} path='<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>' />,
            Home: (props) => <Icon {...props} path='<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline>' />,
            ChevronRight: (props) => <Icon {...props} path='<polyline points="9 18 15 12 9 6"></polyline>' />,
            ChevronLeft: (props) => <Icon {...props} path='<polyline points="15 18 9 12 15 6"></polyline>' />,
            Package: (props) => <Icon {...props} path='<polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line>' />,
            User: (props) => <Icon {...props} path='<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' />,
            Users: (props) => <Icon {...props} path='<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path>' />,
            UserPlus: (props) => <Icon {...props} path='<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line>' />,
            UserCheck: (props) => <Icon {...props} path='<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><polyline points="17 11 19 13 23 9"></polyline>' />,
            History: (props) => <Icon {...props} path='<path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path>' />,
            DollarSign: (props) => <Icon {...props} path='<line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>' />,
            Key: (props) => <Icon {...props} path='<path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>' />,
            LogOut: (props) => <Icon {...props} path='<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line>' />,
            Phone: (props) => <Icon {...props} path='<path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>' />,
            Lock: (props) => <Icon {...props} path='<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>' />,
            Unlock: (props) => <Icon {...props} path='<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>' />,
            FilePdf: (props) => <Icon {...props} path='<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="15" x2="11" y2="15"></line><line x1="10" y1="12" x2="10" y2="18"></line>' />,
            AlertTriangle: (props) => <Icon {...props} path='<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' />,
            BarChart: (props) => <Icon {...props} path='<line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="16"></line>' />,
            Trophy: (props) => <Icon {...props} path='<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17"></path><path d="M14 14.66V17"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>' />,
            WhatsApp: (props) => <Icon {...props} path='<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>' />,
            FileText: (props) => <Icon {...props} path='<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="9"></line>' />,
            Clock: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>' />,
            Tag: (props) => <Icon {...props} path='<path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>' />,
            CheckSquare: (props) => <Icon {...props} path='<polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>' />,
            Square: (props) => <Icon {...props} path='<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>' />,
            Cloud: (props) => <Icon {...props} path='<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>' />,
            CloudUpload: (props) => <Icon {...props} path='<path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h14z"></path><line x1="16" y1="19" x2="16" y2="23"></line><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="19" x2="8" y2="23"></line>' />,
            HelpCircle: (props) => <Icon {...props} path='<circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line>' />,
            Calculator: (props) => <Icon {...props} path='<rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path>' />,
            Wrench: (props) => <Icon {...props} path='<path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>' />
        };

        const SELLERS_LIST = ["Bia Gomez", "Ana Reina", "Pedro Cardoso", "Davison Cerqueira"];
        const EMPLOYEES_CREDENTIALS = { "Bia Gomez": "Bia123", "Ana Reina": "Ana123", "Pedro Cardoso": "Pedro123", "Davison Cerqueira": "#Banana@3433" };
        const CATEGORIES_LIST = ["Venda a vista", "Crediario Payjoy", "Crediario Paymobi", "Crediario Crefaz", "Devolução", "Troca", "Envio Garantia", "Outros"];
        const PRODUCT_TYPES = ["BRINDES", "CABOS", "CAPAS", "CARREGADOR", "CARTÃO SD", "CHIP", "FONES", "HONOR", "IPHONE", "MICROFONE", "MOTOROLA", "OUTROS", "PAGAMENTO", "PELICULA 3D", "PELICULA 9D", "PILHA", "POCO", "REALME", "RECEPTOR", "REDMI", "ROCK SPACE", "SAMSUNG"];
        const RAM_STORAGE_OPTIONS = ["4/128", "4/256", "4/512", "6/128", "6/256", "8/256", "8/512", "12/256", "12/512"];
        const PAYMENT_METHODS = ["Dinheiro", "Pix", "Débito", "Crédito a vista", "Credito Parcelado", "Financiado Nuovo", "Financiado Payjoy", "Financiado Crefaz", "Link de Pagamento", "Pix (Chave de Pagamento)", "Entrada de Aparelho", "Brinde", "Autorizado Dark/Jack"];
        const PAYMENT_TYPES = ["Integral", "Entrada", "Restante", "Parte do Pagamento"];
        const UF_LIST = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
        const ROUTINE_TASKS = {
            morning: ["Fazer Café e limpar a area do cafe", "Limpeza da Loja Geral, Varrer, Passar Pano, Limpar Vitrine e Aparelhos", "Postar Bom dia, Facebook, What's app e Instagram", "Responder Clientes e verificar mensagens em todas redes sociais.", "Enviar os Contratos das vendas do dia anterior", "Verificar Preços da vitrine", "Contagem de estoque de aparelhos"],
            afternoon: ["Responder Clientes e verificar mensagens nas redes sociais", "Fazer Postagens no Facebook nos grupos (feira do rolo)", "Postar no What's app", "Postar Reels com Capa Personalizada", "Fazer post na pagina do Facebook", "Fazer videos da Loja para novos Posts (atendimento, clientes, lançamentos e criativos)", "Entrega de panfletos em dias fracos ou parados"],
            evening: ["Verificar seus lançamentos e seus clientes.", "Pos vendas e seus clientes", "Buscar diariamente novos clientes", "Controle de vendas Individuais"]
        };
        const ELIGIBLE_FOR_GOAL = ["HONOR", "IPHONE", "MOTOROLA", "POCO", "REALME", "REDMI", "SAMSUNG"];
        const GOAL_SELLERS = 45;
        const GOAL_MANAGER = 130;
        const COMMISSION_PER_UNIT = 10;
        const MANAGER_PASSWORD = "#Banana@3433";

        const HELP_LINKS = [
            { title: "Termo de Garantia Android/iPhone", url: "https://termo-a-vista.vercel.app", icon: "FileText" },
            { title: "Termo Responsabilidade Payjoy", url: "https://termo-payjoy.vercel.app", icon: "FileText" },
            { title: "Termo Responsabilidade Nuovo", url: "https://termo-nuovo.vercel.app", icon: "FileText" },
            { title: "Ordem de Serviço", url: "https://o-s-kappa.vercel.app", icon: "Wrench" },
            { title: "Contato Garantias", url: "https://contato-garantia.vercel.app", icon: "Phone" },
            { title: "Calendário Pagamento Nuovo", url: "https://calendario-paymobi.vercel.app", icon: "Calendar" },
            { title: "Calculadora Taxa Cartão", url: "https://calculadora-taxa-de-cart.vercel.app", icon: "Calculator" },
            { title: "Calculadora Payjoy", url: "https://calculadora-payjoy.vercel.app", icon: "Calculator" },
            { title: "Calculadora Nuovo", url: "https://nextjs-boilerplate-xij5.vercel.app", icon: "Calculator" },
            { title: "Suporte ADM", url: "https://wa.me/5519989354849", icon: "WhatsApp" }
        ];

        const validateCPF = (cpf) => {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) return false;
            let sum = 0, remainder;
            for (let i = 1; i <= 9; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if ((remainder === 10) || (remainder === 11)) remainder = 0;
            if (remainder !== parseInt(cpf.substring(9, 10))) return false;
            sum = 0;
            for (let i = 1; i <= 10; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (12 - i);
            remainder = (sum * 10) % 11;
            if ((remainder === 10) || (remainder === 11)) remainder = 0;
            if (remainder !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        };

        const formatDateBR = (dateString) => {
            if (!dateString) return "";
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(Math.round((value + Number.EPSILON) * 100) / 100);
        const parseCurrency = (str) => typeof str !== 'string' ? (typeof str === 'number' ? str : 0) : Math.round((parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0) * 100) / 100;

        const RealTimeClock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const interval = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(interval); }, []);
            return (<div className="flex items-center gap-2 bg-white/10 px-4 py-2 rounded-xl border border-white/20 backdrop-blur-md shadow-lg shadow-black/5 hover:bg-white/20 transition-all duration-300"><Icons.Clock className="w-4 h-4 text-odoo-100" /><span className="font-mono text-sm font-bold text-white tracking-wide">{time.toLocaleTimeString('pt-BR')}</span></div>);
        };

        const HeaderClock = () => {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const interval = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(interval); }, []);
            return (<div className="hidden md:flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-xl border border-slate-200 shadow-inner"><Icons.Clock className="w-4 h-4 text-odoo-500" /><span className="font-mono text-sm font-bold text-slate-700 tracking-wide">{time.toLocaleTimeString('pt-BR')}</span></div>);
        };

        const TaskAlertModal = ({ isOpen, onClose, onGoToCalendar, message, phase, userName }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[300] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm animate-in fade-in duration-300">
                    <div className="bg-white rounded-[2rem] p-8 w-full max-w-md shadow-2xl animate-in zoom-in-95 duration-300 border-4 border-yellow-400 relative overflow-hidden text-center">
                        <div className="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce shadow-inner"><Icons.AlertTriangle className="w-10 h-10 text-yellow-600" /></div>
                        <h3 className="font-black text-3xl mb-2 text-slate-800 font-display uppercase tracking-tight">Atenção</h3>
                        <p className="text-lg font-bold text-odoo-600 mb-4">{userName}</p>
                        <p className="text-slate-600 mb-2 font-medium">Não esqueça de completar suas tarefas diárias</p>
                        <div className="bg-yellow-50 py-2 px-4 rounded-lg inline-block mb-4 border border-yellow-200"><p className="font-black text-yellow-700 uppercase tracking-widest text-sm">{phase}</p></div>
                        <p className="text-slate-500 mb-8 font-medium">Existe Pendências para Finaliza-las!</p>
                        <div className="flex flex-col gap-3">
                            <button onClick={onGoToCalendar} className="w-full p-4 bg-gradient-to-r from-odoo-500 to-odoo-600 hover:from-odoo-600 hover:to-odoo-700 text-white rounded-2xl font-bold shadow-lg shadow-odoo-500/30 transition-all active-scale uppercase tracking-wide flex items-center justify-center gap-2"><Icons.Calendar className="w-5 h-5" /> Verificar Calendário</button>
                            <button onClick={onClose} className="w-full p-4 bg-slate-100 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-2xl font-bold transition-colors active-scale uppercase tracking-wide text-xs">Ver depois (fecha alerta)</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SimpleCalendar = ({ routineState, toggleRoutine }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [reminders, setReminders] = useState([]);
            const [isReminderModalOpen, setIsReminderModalOpen] = useState(false);
            const [newReminder, setNewReminder] = useState({ desc: '', time: '', type: 'Geral' });
            
            useEffect(() => { const saved = localStorage.getItem('lembretes_odoo_v1'); if (saved) setReminders(JSON.parse(saved)); }, []);
            useEffect(() => { localStorage.setItem('lembretes_odoo_v1', JSON.stringify(reminders)); }, [reminders]);

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const selectedDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            
            const handleAddReminder = () => {
                if (!newReminder.desc) return;
                setReminders([...reminders, { id: Date.now(), date: selectedDateStr, description: newReminder.desc, time: newReminder.time || '09:00', type: newReminder.type, completed: false }]);
                setNewReminder({ desc: '', time: '', type: 'Geral' });
                setIsReminderModalOpen(false);
            };

            const toggleReminder = (id) => setReminders(reminders.map(r => r.id === id ? { ...r, completed: !r.completed } : r));
            const deleteReminder = (id) => setReminders(reminders.filter(r => r.id !== id));
            const dayReminders = reminders.filter(r => r.date === selectedDateStr).sort((a,b) => a.time.localeCompare(b.time));
            const getTypeColor = (type) => { switch(type) { case 'Ligação': return 'bg-blue-500'; case 'Reunião': return 'bg-purple-500'; case 'Cobrança': return 'bg-red-500'; default: return 'bg-slate-500'; } };

            return (
                <div className="flex flex-col gap-6 animate-fade-in-up">
                    <div className="flex flex-col lg:flex-row gap-6">
                        <div className="flex-1 glass rounded-3xl shadow-xl shadow-odoo-200/50 border border-white overflow-hidden transition-all hover:shadow-2xl">
                            <div className="p-6 border-b border-white/50 flex justify-between items-center bg-gradient-to-r from-white/80 to-white/40">
                                <h2 className="text-xl font-bold text-slate-800 flex items-center gap-3 font-display"><div className="p-2.5 bg-white rounded-xl shadow-lg shadow-odoo-100 text-odoo-600"><Icons.Calendar className="w-6 h-6"/></div>{monthNames[month]} <span className="text-odoo-400 font-light">{year}</span></h2>
                                <div className="flex gap-2">
                                    <button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="p-2.5 hover:bg-white rounded-xl transition-all hover:scale-110 active-scale shadow-sm bg-white/50"><Icons.ChevronLeft className="w-5 h-5"/></button>
                                    <button onClick={() => setCurrentDate(new Date())} className="px-4 py-2 text-sm font-bold text-odoo-700 hover:text-white hover:bg-odoo-500 rounded-xl transition-all active-scale bg-odoo-100">Hoje</button>
                                    <button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="p-2.5 hover:bg-white rounded-xl transition-all hover:scale-110 active-scale shadow-sm bg-white/50"><Icons.ChevronRight className="w-5 h-5"/></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-7 bg-slate-50/50 gap-px border-b border-white/50 backdrop-blur-sm">
                                {["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"].map(d => (<div key={d} className="bg-white/60 p-3 text-center text-xs font-bold text-slate-400 uppercase tracking-widest">{d}</div>))}
                                {Array.from({ length: firstDay }).map((_, i) => <div key={`empty-${i}`} className="bg-white/40 h-28 sm:h-36"></div>)}
                                {Array.from({ length: daysInMonth }).map((_, i) => {
                                    const d = i + 1;
                                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                                    const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();
                                    const isSelected = d === currentDate.getDate() && month === currentDate.getMonth() && year === currentDate.getFullYear();
                                    const hasReminders = reminders.some(r => r.date === dateStr && !r.completed);
                                    return (
                                        <div key={d} onClick={() => setCurrentDate(new Date(year, month, d))} className={`h-28 sm:h-36 p-3 border-white/50 relative group cursor-pointer transition-all duration-300 hover:bg-white/80 ${isSelected ? 'bg-odoo-50/80 ring-inset ring-2 ring-odoo-200' : 'bg-white/40'}`}>
                                            <span className={`text-sm font-bold w-8 h-8 flex items-center justify-center rounded-full transition-all duration-500 ${isToday ? 'bg-gradient-to-br from-odoo-500 to-odoo-600 text-white shadow-lg shadow-odoo-500/40 scale-110' : isSelected ? 'bg-odoo-100 text-odoo-700' : 'text-slate-600 group-hover:bg-slate-100'}`}>{d}</span>
                                            {hasReminders && <div className="absolute top-4 right-4 w-2.5 h-2.5 bg-red-500 rounded-full animate-pulse shadow-lg shadow-red-500/30"></div>}
                                            <div className="mt-3 space-y-1.5 overflow-hidden">{reminders.filter(r => r.date === dateStr).slice(0, 3).map((r, idx) => (<div key={idx} className={`text-[10px] font-medium truncate px-2 py-1 rounded-md border border-transparent transition-all ${r.completed ? 'bg-slate-100/80 text-slate-400 line-through' : 'bg-white/90 text-odoo-700 shadow-sm border-white'}`}>{r.description}</div>))}</div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="w-full lg:w-96 flex flex-col gap-6">
                            <div className="glass rounded-3xl shadow-xl shadow-slate-200/50 border border-white p-6 flex flex-col h-full bg-gradient-to-b from-white to-slate-50/50">
                                <div className="flex justify-between items-center mb-6">
                                    <div><h3 className="font-bold text-xl text-slate-800 font-display">Agenda</h3><p className="text-xs text-odoo-500 font-bold uppercase tracking-wider">{currentDate.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
                                    <button onClick={() => setIsReminderModalOpen(true)} className="p-3 bg-gradient-to-r from-odoo-500 to-odoo-600 hover:from-odoo-600 hover:to-odoo-700 text-white rounded-2xl shadow-lg shadow-odoo-500/30 transition-all active-scale hover:rotate-90 duration-300"><Icons.Plus className="w-5 h-5" /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3 pr-2">
                                    {dayReminders.length === 0 ? (<div className="text-center py-12 text-slate-400"><div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-float"><Icons.Calendar className="w-10 h-10 opacity-30"/></div><p className="text-sm font-medium">Sem tarefas agendadas.</p></div>) : (dayReminders.map(r => (<div key={r.id} className={`p-4 rounded-2xl border transition-all duration-300 group hover:-translate-y-1 hover:shadow-lg ${r.completed ? 'bg-slate-50 border-slate-100 opacity-60' : 'bg-white border-slate-100 hover:border-odoo-100 shadow-sm'}`}><div className="flex items-start gap-3"><button onClick={() => toggleReminder(r.id)} className={`mt-0.5 min-w-[22px] h-[22px] rounded-lg border-2 flex items-center justify-center transition-all duration-300 ${r.completed ? 'bg-green-500 border-green-500 text-white scale-110' : 'border-slate-200 hover:border-odoo-500 text-transparent'}`}><Icons.Check className="w-3.5 h-3.5" /></button><div className="flex-1"><p className={`text-sm font-medium leading-tight transition-all duration-300 ${r.completed ? 'line-through text-slate-400' : 'text-slate-700'}`}>{r.description}</p><div className="flex items-center gap-2 mt-2.5"><span className={`w-2 h-2 rounded-full ring-2 ring-white shadow-sm ${getTypeColor(r.type)}`}></span><span className="text-xs text-slate-400 font-mono font-bold">{r.time}</span><span className="text-[10px] font-bold text-slate-500 uppercase tracking-wider border border-slate-200 px-2 py-0.5 rounded-full bg-slate-50">{r.type}</span></div></div><button onClick={() => deleteReminder(r.id)} className="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all active-scale"><Icons.Trash2 className="w-4 h-4" /></button></div></div>)))}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="glass rounded-3xl shadow-xl shadow-slate-200/50 border border-white p-8">
                        <h3 className="font-bold text-2xl text-slate-800 mb-8 flex items-center gap-3 font-display"><div className="p-2.5 bg-gradient-to-br from-odoo-500 to-odoo-600 rounded-xl shadow-lg shadow-odoo-500/30 text-white"><Icons.CheckSquare className="w-6 h-6"/></div>Tarefas do Dia <span className="text-slate-400 font-normal text-lg ml-2 hidden sm:inline">(Rotina)</span></h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            {['morning', 'afternoon', 'evening'].map(phase => (
                                <div key={phase} className="space-y-4">
                                    <div className="flex items-center gap-2 mb-4 pb-3 border-b border-slate-200"><div className={`w-2 h-2 rounded-full animate-pulse ${phase === 'morning' ? 'bg-yellow-400' : phase === 'afternoon' ? 'bg-orange-400' : 'bg-indigo-400'}`}></div><div className="font-bold text-slate-700 uppercase tracking-widest text-xs">{phase === 'morning' ? 'Início - Manhã' : phase === 'afternoon' ? 'Meio - Tarde' : 'Fim - Fechamento'}</div></div>
                                    {ROUTINE_TASKS[phase].map((task, idx) => {
                                        const isChecked = routineState[`${phase}-${idx}`];
                                        return (<div key={idx} onClick={() => toggleRoutine(phase, idx)} className={`flex items-start gap-4 p-4 rounded-2xl border transition-all cursor-pointer group duration-300 hover:scale-[1.02] active:scale-[0.98] ${isChecked ? 'bg-green-50/50 border-green-200 shadow-inner' : 'bg-white border-white hover:border-slate-200 hover:shadow-md shadow-sm'}`}><div className={`mt-0.5 min-w-[20px] h-[20px] rounded-md border-2 flex items-center justify-center transition-all duration-300 ${isChecked ? 'bg-green-500 border-green-500 text-white rotate-0' : 'border-slate-200 bg-slate-50 group-hover:border-yellow-400 -rotate-12 group-hover:rotate-0'}`}>{isChecked && <Icons.Check className="w-3.5 h-3.5" />}</div><span className={`text-sm font-medium leading-snug transition-all duration-300 ${isChecked ? 'text-green-800 line-through opacity-60' : 'text-slate-600 group-hover:text-slate-900'}`}>{task}</span></div>);
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                    {isReminderModalOpen && (
                        <div className="fixed inset-0 z-[200] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md animate-in fade-in duration-300" onClick={() => setIsReminderModalOpen(false)}>
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-sm shadow-2xl animate-in zoom-in-95 duration-300 border border-white/20 relative overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-odoo-400 to-odoo-600"></div>
                                <h3 className="font-bold text-2xl mb-6 text-slate-800 font-display">Novo Lembrete</h3>
                                <div className="space-y-5">
                                    <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block tracking-wider">Descrição</label><input type="text" value={newReminder.desc} onChange={e => setNewReminder({...newReminder, desc: e.target.value})} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 bg-slate-50 focus:bg-white transition-all font-medium" placeholder="Ex: Ligar para cliente..." autoFocus /></div>
                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block tracking-wider">Horário</label><input type="time" value={newReminder.time} onChange={e => setNewReminder({...newReminder, time: e.target.value})} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 bg-slate-50 focus:bg-white transition-all font-bold" /></div><div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block tracking-wider">Tipo</label><select value={newReminder.type} onChange={e => setNewReminder({...newReminder, type: e.target.value})} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 bg-slate-50 focus:bg-white transition-all font-medium"><option value="Geral">Geral</option><option value="Ligação">Ligação</option><option value="Reunião">Reunião</option><option value="Cobrança">Cobrança</option></select></div></div>
                                    <div className="flex gap-3 pt-4"><button onClick={() => setIsReminderModalOpen(false)} className="flex-1 p-4 bg-slate-100 text-slate-600 rounded-2xl font-bold hover:bg-slate-200 transition-colors active-scale">Cancelar</button><button onClick={handleAddReminder} className="flex-1 p-4 bg-gradient-to-r from-odoo-500 to-odoo-600 hover:from-odoo-600 hover:to-odoo-700 text-white rounded-2xl font-bold shadow-lg shadow-odoo-500/30 transition-all active-scale">Salvar</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const DateInput = ({ value, onChange, required, className, placeholder }) => {
            const [inputType, setInputType] = useState('text');
            return (<div className="relative w-full group"><input type={inputType} required={required} value={inputType === 'text' && value ? formatDateBR(value) : value} onChange={onChange} onFocus={(e) => { setInputType('date'); if (e.target.showPicker) e.target.showPicker(); }} onBlur={() => setInputType('text')} className={`transition-all duration-200 input-focus-effect ${className}`} placeholder={placeholder || "dd/mm/aaaa"} />{inputType === 'text' && (<div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 group-hover:text-odoo-500 transition-colors"><Icons.Calendar className="w-5 h-5" /></div>)}</div>);
        };

        const maskCPF = (value) => value.replace(/\D/g, '').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})/, '$1-$2').replace(/(-\d{2})\d+?$/, '$1'); 
        const maskPhone = (value) => value.replace(/\D/g, '').replace(/^(\d{2})(\d)/g, '($1) $2').replace(/(\d{5})(\d{4})/, '$1-$2').slice(0, 15); 
        const maskDateStrict = (value) => value.replace(/\D/g, '').replace(/(\d{2})(\d)/, '$1/$2').replace(/(\d{2})(\d)/, '$1/$2').replace(/(\d{4})\d+?$/, '$1');
        const maskCEP = (value) => value.replace(/\D/g, '').replace(/^(\d{5})(\d)/, '$1-$2').slice(0, 9);
        const maskIMEI = (value) => value.replace(/\D/g, '').slice(0, 15);

        const ToastContainer = ({ toasts, removeToast }) => (<div className="fixed top-6 right-6 z-[200] flex flex-col gap-4 pointer-events-none">{toasts.map(toast => (<div key={toast.id} className={`pointer-events-auto flex items-center gap-4 px-6 py-5 rounded-2xl shadow-2xl border-l-[6px] transform transition-all duration-500 animate-slide-in-right glass-dark ${toast.type === 'error' ? 'border-red-500' : toast.type === 'success' ? 'border-green-500' : 'border-odoo-500'}`}><div className={`p-2 rounded-full ${toast.type === 'error' ? 'bg-red-500/20 text-red-400' : toast.type === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-odoo-500/20 text-odoo-400'}`}>{toast.type === 'error' ? <Icons.AlertCircle className="w-6 h-6"/> : toast.type === 'success' ? <Icons.Check className="w-6 h-6"/> : <Icons.AlertCircle className="w-6 h-6"/>}</div><p className="font-bold text-white text-sm tracking-wide">{toast.message}</p><button onClick={() => removeToast(toast.id)} className="text-slate-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-lg"><Icons.X className="w-5 h-5" /></button></div>))}</div>);

        const App = () => {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [sales, setSales] = useState([]);
            const [clients, setClients] = useState([]);
            const [settings, setSettings] = useState({ employeeName: "", currency: "R$" });
            const [toasts, setToasts] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterDate, setFilterDate] = useState(''); 
            const [groupBy, setGroupBy] = useState('date');
            const [currentView, setCurrentView] = useState('dashboard');
            const [clientSearchModalOpen, setClientSearchModalOpen] = useState(false);
            const [clientSearchTerm, setClientSearchTerm] = useState('');
            const [clientHistoryModalOpen, setClientHistoryModalOpen] = useState(false);
            const [clientDataModalOpen, setClientDataModalOpen] = useState(false);
            const [selectedClientForEdit, setSelectedClientForEdit] = useState(null);
            const [selectedClientHistory, setSelectedClientHistory] = useState(null);
            const [managerAuthModalOpen, setManagerAuthModalOpen] = useState(false);
            const [managerPassword, setManagerPassword] = useState('');
            const [loginModalOpen, setLoginModalOpen] = useState(false);
            const [selectedUserForLogin, setSelectedUserForLogin] = useState(null);
            const [loginPasswordInput, setLoginPasswordInput] = useState('');
            const [receiptModalOpen, setReceiptModalOpen] = useState(false);
            const [currentReceipt, setCurrentReceipt] = useState(null);
            const [dateLockModalOpen, setDateLockModalOpen] = useState(false);
            const [dateLockPassword, setDateLockPassword] = useState('');
            const [isBackupOpen, setIsBackupOpen] = useState(false);
            const [logoutModalOpen, setLogoutModalOpen] = useState(false);
            const [confirmSaleModalOpen, setConfirmSaleModalOpen] = useState(false);
            const [confirmClientUpdateModalOpen, setConfirmClientUpdateModalOpen] = useState(false);
            const fileInputInternalRef = useRef(null);
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 50;
            const [editingId, setEditingId] = useState(null);
            const [date, setDate] = useState(() => { const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; });
            const [isDateLocked, setIsDateLocked] = useState(true);
            const [clientName, setClientName] = useState('');
            const [clientCpf, setClientCpf] = useState('');
            const [clientPhone, setClientPhone] = useState('');
            const [clientEmail, setClientEmail] = useState('');
            const [clientDob, setClientDob] = useState('');
            const [clientAddress, setClientAddress] = useState('');
            const [clientNumber, setClientNumber] = useState('');
            const [clientCity, setClientCity] = useState('');
            const [clientZip, setClientZip] = useState('');
            const [clientState, setClientState] = useState('');
            const [clientNeighborhood, setClientNeighborhood] = useState('');
            const [category, setCategory] = useState('');
            const [items, setItems] = useState([]); 
            const [newItemQty, setNewItemQty] = useState(1);
            const [newItemType, setNewItemType] = useState(''); 
            const [newItemDesc, setNewItemDesc] = useState('');
            const [newItemRam, setNewItemRam] = useState('');
            const [newItemColor, setNewItemColor] = useState('');
            const [newItemImei, setNewItemImei] = useState('');
            const [newItemFinanced, setNewItemFinanced] = useState('Não');
            const [newItemPrice, setNewItemPrice] = useState('');
            const [newItemDiscount, setNewItemDiscount] = useState('');
            const [newItemDiscountPercent, setNewItemDiscountPercent] = useState('');
            const [exchangeAction, setExchangeAction] = useState('out');
            const [paymentList, setPaymentList] = useState([]);
            const [currentPaymentMethod, setCurrentPaymentMethod] = useState('');
            const [currentPaymentType, setCurrentPaymentType] = useState('');
            const [currentPaymentAmount, setCurrentPaymentAmount] = useState('');
            const [currentInstallments, setCurrentInstallments] = useState('');
            const [pendingAuthAction, setPendingAuthAction] = useState(null);
            const [pendingEditItem, setPendingEditItem] = useState(null);
            const [routineState, setRoutineState] = useState(() => { const today = new Date().toISOString().split('T')[0]; const saved = localStorage.getItem(`rotina_state_${today}`); return saved ? JSON.parse(saved) : {}; });
            const [alertModalOpen, setAlertModalOpen] = useState(false);
            const [alertData, setAlertData] = useState({ message: '', phase: '' });
            const [lastAlertTime, setLastAlertTime] = useState(0);
            
            const [isHelpDropdownOpen, setIsHelpDropdownOpen] = useState(false);

            // --- FIREBASE SYNC & AUTH ---
            useEffect(() => {
                const tryLogin = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (error) {
                        console.error("Erro Auth:", error);
                        if (error.code === 'auth/configuration-not-found' || error.code === 'auth/operation-not-allowed') {
                            showToast("⚠️ ATENÇÃO: Ative 'Anônimo' no Firebase Console", "error");
                        } else {
                            showToast("Erro de conexão: " + error.message, "error");
                        }
                    }
                };

                const unsubscribeAuth = auth.onAuthStateChanged(user => {
                    if (user) {
                        console.log("Conectado como:", user.uid);
                        const unsubSales = db.collection('vendas').onSnapshot(snapshot => {
                            const loadedSales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setSales(loadedSales);
                        }, err => console.error("Erro sincronia vendas:", err));

                        const unsubClients = db.collection('clientes').onSnapshot(snapshot => {
                            const loadedClients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setClients(loadedClients);
                        }, err => console.error("Erro sincronia clientes:", err));

                        return () => { unsubSales(); unsubClients(); };
                    } else {
                        tryLogin();
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            // Salvar configurações locais
            useEffect(() => {
                const st = localStorage.getItem('vendas_settings_v14'); 
                if (st) { 
                    const p = JSON.parse(st); 
                    setSettings(p); 
                    if (p.employeeName) setIsLoggedIn(true); 
                }
            }, []);
            useEffect(() => localStorage.setItem('vendas_settings_v14', JSON.stringify(settings)), [settings]);

            const toggleRoutine = (category, index) => {
                const key = `${category}-${index}`;
                setRoutineState(prev => {
                    const newState = {...prev, [key]: !prev[key]};
                    const today = new Date().toISOString().split('T')[0];
                    localStorage.setItem(`rotina_state_${today}`, JSON.stringify(newState));
                    return newState;
                });
            };

            const playAlertSound = () => { try { new Audio('speech_1771176567518.mp3').play().catch(e => console.error(e)); } catch (e) { console.error(e); } };

            useEffect(() => {
                if (!isLoggedIn) return;
                const checkAlerts = () => {
                    const now = new Date();
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();
                    if (Date.now() - lastAlertTime < 15 * 60 * 1000) return;

                    let shouldTrigger = false, phaseName = "";
                    const phases = [
                        { name: "Início - Manhã", start: 570, end: 780, key: "morning" },
                        { name: "Meio - Tarde", start: 810, end: 990, key: "afternoon" },
                        { name: "Fim - Fechamento", start: 1020, end: 1110, key: "evening" }
                    ];

                    for (const p of phases) {
                        if (currentMinutes >= p.start && currentMinutes <= p.end) {
                            if (!ROUTINE_TASKS[p.key].every((_, i) => routineState[`${p.key}-${i}`])) {
                                shouldTrigger = true; phaseName = p.name; break;
                            }
                        }
                    }

                    if (shouldTrigger) {
                        setAlertData({ phase: phaseName, message: `(${settings.employeeName}) Não esqueça de completar suas tarefas diárias\n${phaseName}\nExiste Pendências!` });
                        setAlertModalOpen(true);
                        setLastAlertTime(Date.now());
                        playAlertSound();
                    }
                };
                const interval = setInterval(checkAlerts, 60000);
                checkAlerts();
                return () => clearInterval(interval);
            }, [isLoggedIn, routineState, lastAlertTime]);

            useEffect(() => {
                const handleBeforeUnload = (e) => { if (items.length > 0) { e.preventDefault(); e.returnValue = ''; } };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [items]);

            const totalAmount = useMemo(() => items.reduce((acc, item) => acc + (item.unitPrice * (item.quantity || 1)), 0), [items]);
            const totalDiscount = useMemo(() => items.reduce((acc, item) => acc + (item.discount || 0), 0), [items]);
            const finalTotal = totalAmount - totalDiscount;
            const totalPaid = useMemo(() => paymentList.reduce((acc, p) => acc + p.amount, 0), [paymentList]);
            const changeAmount = totalPaid - finalTotal;
            const remainingToPay = Math.max(0, Math.round(((finalTotal - totalPaid) + Number.EPSILON) * 100) / 100);

            const getPaymentStyles = (type) => {
                switch(type) {
                    case 'Entrada': return { wrapper: 'bg-emerald-50 border-emerald-200 text-emerald-800', amount: 'text-emerald-700' };
                    case 'Parte do Pagamento': return { wrapper: 'bg-slate-100 border-slate-200 text-slate-800', amount: 'text-slate-600' };
                    case 'Restante': return { wrapper: 'bg-indigo-50 border-indigo-200 text-indigo-800', amount: 'text-indigo-700' };
                    default: return { wrapper: 'bg-sky-50 border-sky-200 text-sky-800', amount: 'text-sky-700' };
                }
            };

            useEffect(() => {
                if (receiptModalOpen) document.body.classList.add('receipt-open');
                else document.body.classList.remove('receipt-open');
            }, [receiptModalOpen]);

            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };

            const fillClientData = (f) => {
                setClientName(f.name); setClientCpf(f.cpf || ''); setClientPhone(f.phone || ''); setClientEmail(f.email || ''); setClientDob(f.dob || ''); setClientAddress(f.address || ''); setClientNumber(f.number || ''); setClientNeighborhood(f.neighborhood || ''); setClientCity(f.city || ''); setClientZip(f.zip || ''); setClientState(f.state || '');
            };

            const handleZipChange = async (e) => {
                const value = maskCEP(e.target.value); setClientZip(value);
                if (value.replace(/\D/g, '').length === 8) {
                    try {
                        showToast("Buscando endereço...", "info");
                        const res = await fetch(`https://viacep.com.br/ws/${value.replace(/\D/g, '')}/json/`);
                        const data = await res.json();
                        if (!data.erro) { setClientAddress(data.logradouro); setClientCity(data.localidade); setClientState(data.uf); setClientNeighborhood(data.bairro); showToast("Endereço encontrado!"); }
                    } catch (err) { console.error(err); }
                }
            };

            const handleCpfChange = (e) => {
                const val = maskCPF(e.target.value); setClientCpf(val);
                if (val.replace(/\D/g, '').length === 11) {
                    const f = clients.find(c => c.cpf && c.cpf.replace(/\D/g, '') === val.replace(/\D/g, ''));
                    if (f) { showToast("Cliente encontrado!", "info"); fillClientData(f); }
                }
            };

            const handleSaveClient = () => {
                if (!clientName) { showToast("Nome é obrigatório", "error"); return; }
                if (clientCpf && !validateCPF(clientCpf)) { showToast("CPF Inválido", "error"); return; }

                const existingClient = clients.find(c => (c.cpf && clientCpf && c.cpf === clientCpf) || (c.name.trim().toLowerCase() === clientName.trim().toLowerCase()));
                const clientId = existingClient ? existingClient.id : (db.collection('clientes').doc().id);

                const clientData = { 
                    id: clientId,
                    name: clientName, cpf: clientCpf, phone: clientPhone, email: clientEmail, dob: clientDob, 
                    address: clientAddress, number: clientNumber, neighborhood: clientNeighborhood, 
                    city: clientCity, zip: clientZip, state: clientState,
                    createdBy: existingClient ? existingClient.createdBy : settings.employeeName,
                    createdAt: existingClient ? existingClient.createdAt : new Date().toISOString()
                };

                db.collection('clientes').doc(clientId).set(clientData)
                    .then(() => showToast("Dados salvos na carteira (Nuvem)!"))
                    .catch(err => showToast("Erro ao salvar: " + err.message, "error"));
            };
            
            const handleOpenClientData = (client) => {
                setSelectedClientForEdit({ ...client });
                setClientDataModalOpen(true);
            };

            const handleClientDataChange = (field, value) => {
                setSelectedClientForEdit(prev => ({ ...prev, [field]: value }));
            };

            const confirmClientUpdate = () => {
                setPendingAuthAction('update_client');
                setManagerAuthModalOpen(true);
            };

            const performClientUpdate = async () => {
                const clientRef = db.collection('clientes').doc(selectedClientForEdit.id);
                const batch = db.batch();
                batch.update(clientRef, selectedClientForEdit);

                const salesToUpdate = sales.filter(s => {
                    const originalClient = clients.find(c => c.id === selectedClientForEdit.id);
                    return (originalClient?.cpf && s.clientCpf === originalClient.cpf) || (s.clientName.trim().toLowerCase() === originalClient?.name.trim().toLowerCase());
                });

                salesToUpdate.forEach(sale => {
                    const saleRef = db.collection('vendas').doc(sale.id);
                    batch.update(saleRef, {
                        clientName: selectedClientForEdit.name,
                        clientCpf: selectedClientForEdit.cpf,
                        clientPhone: selectedClientForEdit.phone,
                        clientEmail: selectedClientForEdit.email,
                        clientDob: selectedClientForEdit.dob,
                        clientAddress: selectedClientForEdit.address,
                        clientNumber: selectedClientForEdit.number,
                        clientNeighborhood: selectedClientForEdit.neighborhood,
                        clientCity: selectedClientForEdit.city,
                        clientState: selectedClientForEdit.state,
                        clientZip: selectedClientForEdit.zip
                    });
                });

                try {
                    await batch.commit();
                    showToast("Dados atualizados com sucesso!");
                    setConfirmClientUpdateModalOpen(false);
                    setClientDataModalOpen(false);
                } catch (error) {
                    showToast("Erro ao atualizar: " + error.message, "error");
                }
            };

            const handleAddItem = () => {
                if (!newItemType) { showToast("Selecione o Tipo do item", "error"); return; }
                if (!newItemDesc || !newItemPrice) { showToast("Preencha Descrição e Preço", "error"); return; }
                
                let finalPrice = parseCurrency(newItemPrice);
                let finalDiscount = parseCurrency(newItemDiscount);
                
                if (category === 'Devolução') { finalPrice = -Math.abs(finalPrice); finalDiscount = -Math.abs(finalDiscount); } 
                else if (category === 'Troca') {
                    if (exchangeAction === 'in') { finalPrice = -Math.abs(finalPrice); finalDiscount = -Math.abs(finalDiscount); } 
                    else { finalPrice = Math.abs(finalPrice); finalDiscount = Math.abs(finalDiscount); }
                }

                setItems([...items, { id: Date.now(), sequence: items.length + 1, quantity: newItemQty, type: newItemType || 'PRODUTO', description: newItemDesc, ram_storage: newItemRam, color: newItemColor, imei: newItemImei, financed: newItemFinanced, unitPrice: finalPrice, discount: finalDiscount }]);
                setNewItemQty(1); setNewItemType(''); setNewItemDesc(''); setNewItemRam(''); setNewItemColor(''); setNewItemImei(''); setNewItemFinanced('Não'); setNewItemPrice(''); setNewItemDiscount(''); setNewItemDiscountPercent('');
            };

            const handleAddPayment = () => {
                if (!currentPaymentMethod || !currentPaymentAmount) { showToast("Preencha Forma e Valor", "error"); return; }
                let amountToAdd = parseCurrency(currentPaymentAmount);
                if (["Devolução Dinheiro", "Devolução Pix", "Devolução Estorno Cartão"].includes(currentPaymentMethod)) { amountToAdd = -Math.abs(amountToAdd); }
                setPaymentList([...paymentList, { id: Date.now(), method: currentPaymentMethod, type: currentPaymentType || 'Integral', amount: amountToAdd, installments: currentPaymentMethod === 'Credito Parcelado' ? currentInstallments : null }]);
                setCurrentPaymentMethod(''); setCurrentPaymentType(''); setCurrentPaymentAmount(''); setCurrentInstallments('');
            };

            const handleRemovePayment = (id) => setPaymentList(paymentList.filter(p => p.id !== id));
            const handleRemoveItem = (id) => setItems(items.filter(i => i.id !== id));
            const resetForm = () => { setClientName(''); setClientCpf(''); setClientPhone(''); setClientEmail(''); setClientDob(''); setClientAddress(''); setClientNumber(''); setClientCity(''); setClientZip(''); setClientState(''); setClientNeighborhood(''); setItems([]); setEditingId(null); setIsDateLocked(true); setPaymentList([]); setCurrentPaymentMethod(''); setCurrentPaymentType(''); setCurrentPaymentAmount(''); setCurrentInstallments(''); };
            const openReceipt = (sale) => { setCurrentReceipt(sale); setReceiptModalOpen(true); };

            const performSave = () => {
                if (clientName) handleSaveClient();
                const safeTotal = Math.round((finalTotal + Number.EPSILON) * 100) / 100;
                const safeDiscount = Math.round((totalDiscount + Number.EPSILON) * 100) / 100;

                const saleId = editingId || db.collection('vendas').doc().id;
                
                const saleData = { 
                    id: saleId,
                    date, 
                    timestamp: new Date().toISOString(),
                    clientName, clientCpf, clientPhone, clientEmail, clientDob, clientAddress, clientNumber, clientCity, clientZip, clientState, clientNeighborhood, category, items, amount: safeTotal, discount: safeDiscount, employeeName: settings.employeeName, store: "Miplace Dompedro", payments: paymentList, amountPaid: totalPaid, change: changeAmount 
                };

                db.collection('vendas').doc(saleId).set(saleData)
                    .then(() => {
                        showToast(editingId ? "Atualizado na nuvem!" : "Venda registrada na nuvem!");
                        if (!editingId) openReceipt(saleData);
                        resetForm();
                    })
                    .catch(err => showToast("Erro ao salvar: " + err.message, "error"));
            };

            const performDelete = () => {
                if (editingId) {
                    db.collection('vendas').doc(editingId).delete()
                        .then(() => { showToast("Excluído da nuvem!", "error"); resetForm(); })
                        .catch(err => showToast("Erro ao excluir: " + err.message, "error"));
                }
            };

            const handleSubmit = (e) => { 
                e.preventDefault(); 
                if (items.length === 0) { showToast("Adicione itens!", "error"); return; } 
                const isRefundOrExchangeCredit = finalTotal < 0; 
                if (!isRefundOrExchangeCredit && totalPaid < finalTotal - 0.02) { 
                    setPendingAuthAction('save'); 
                    setManagerAuthModalOpen(true); 
                    return; 
                } 
                setConfirmSaleModalOpen(true);
            };
            
            const handleManagerAuth = async () => { 
                if (managerPassword === MANAGER_PASSWORD) {
                    if (pendingAuthAction === 'save') performSave();
                    if (pendingAuthAction === 'reset') performFactoryReset();
                    if (pendingAuthAction === 'edit' && pendingEditItem) startEdit(pendingEditItem);
                    if (pendingAuthAction === 'delete') performDelete();
                    if (pendingAuthAction === 'update_client') performClientUpdate();
                    
                    setManagerAuthModalOpen(false); 
                    setManagerPassword(''); 
                    setPendingAuthAction(null);
                    setPendingEditItem(null);
                } else { 
                    showToast("Senha incorreta", "error"); 
                } 
            };

            const handleItemPriceChange = (e) => { 
                const val = e.target.value.replace(/\D/g, ''); const floatVal = parseFloat(val) / 100 || 0; 
                setNewItemPrice(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(floatVal));
                if (newItemDiscountPercent) {
                    const pct = parseFloat(newItemDiscountPercent.replace(',', '.')) || 0;
                    setNewItemDiscount(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format((floatVal * newItemQty) * (pct / 100)));
                }
            };

            const handlePercentChange = (e) => {
                const val = e.target.value.replace(',', '.'); setNewItemDiscountPercent(val);
                if (newItemPrice) {
                    const price = parseCurrency(newItemPrice);
                    const pct = parseFloat(val) || 0;
                    setNewItemDiscount(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format((price * newItemQty) * (pct / 100)));
                }
            };

            const handleDiscountValChange = (e) => { 
                const val = e.target.value.replace(/\D/g, ''); const floatVal = parseFloat(val) / 100 || 0; 
                setNewItemDiscount(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(floatVal));
                if (newItemPrice) {
                    const price = parseCurrency(newItemPrice) * newItemQty;
                    if (price > 0) setNewItemDiscountPercent(((floatVal / price) * 100).toFixed(2).replace('.', ','));
                }
            };

            const handleCurrentPaymentAmountChange = (e) => { const val = e.target.value.replace(/\D/g, ''); const floatVal = parseFloat(val) / 100 || 0; setCurrentPaymentAmount(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2 }).format(floatVal)); };

            const handleExportBackup = async () => {
                const data = { sales, clients, settings };
                const fileName = `backup_miplace_${new Date().toISOString().split('T')[0]}.json`;
                const jsonString = JSON.stringify(data);
                try {
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({ suggestedName: fileName, types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }] });
                        const writable = await handle.createWritable();
                        await writable.write(jsonString); await writable.close(); showToast("Arquivo salvo com sucesso!");
                        if(logoutModalOpen) setLogoutModalOpen(false); return;
                    }
                } catch (err) { if (err.name === 'AbortError') return; }
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = fileName; a.click();
                showToast("Backup salvo na pasta padrão!"); if(logoutModalOpen) setLogoutModalOpen(false);
            };

            const handleSaveToCloud = async () => {
                if (!auth.currentUser) {
                    showToast("Erro: Não conectado à nuvem.", "error");
                    return;
                }
                showToast("Verificando sincronização com a nuvem...", "info");
                try {
                    await db.collection('system_logs').add({
                        action: 'manual_cloud_save',
                        user: settings.employeeName,
                        timestamp: new Date().toISOString()
                    });
                    setTimeout(() => showToast("Sucesso! Todos os dados estão salvos na nuvem."), 1000);
                } catch (e) {
                    showToast("Erro ao conectar com a nuvem.", "error");
                }
            };

            const handleImportBackup = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const readFile = (file) => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (event) => { try { resolve(JSON.parse(event.target.result)); } catch (err) { reject(err); } };
                    reader.onerror = reject;
                    reader.readAsText(file);
                });

                try {
                    const loadedDataList = await Promise.all(files.map(file => readFile(file)));
                    const batch = db.batch();
                    let count = 0;

                    loadedDataList.forEach(data => {
                        if (data.sales && Array.isArray(data.sales)) {
                            data.sales.forEach(s => {
                                const ref = db.collection('vendas').doc(s.id);
                                batch.set(ref, s);
                                count++;
                            });
                        }
                        if (data.clients && Array.isArray(data.clients)) {
                            data.clients.forEach(c => {
                                const ref = db.collection('clientes').doc(c.id);
                                batch.set(ref, c);
                                count++;
                            });
                        }
                    });

                    if (count > 0) {
                        await batch.commit();
                        showToast(`${count} registros importados para a nuvem!`);
                    } else {
                        showToast("Nenhum dado válido encontrado.");
                    }
                    setIsBackupOpen(false);
                    if (fileInputInternalRef.current) fileInputInternalRef.current.value = '';

                } catch (error) {
                    console.error(error);
                    showToast("Erro ao importar: " + error.message, "error");
                }
            };

            const triggerFactoryReset = () => { setPendingAuthAction('reset'); setManagerAuthModalOpen(true); };
            const performFactoryReset = () => {
                localStorage.clear();
                window.location.reload();
            };

            const handleExportReceiptPDF = () => {
                const element = document.getElementById('receipt-paper');
                if (!element) { showToast("Erro: Elemento não encontrado", "error"); return; }
                
                showToast("Gerando PDF...", "info");

                // Clona o elemento para limpar estilos
                const clone = element.cloneNode(true);
                
                // Estilos forçados para o PDF
                clone.style.boxShadow = 'none';
                clone.style.borderRadius = '0';
                clone.style.margin = '0';
                clone.style.padding = '0';
                clone.style.maxWidth = '100%';
                clone.style.width = '80mm'; // Largura fixa 80mm
                clone.style.backgroundColor = '#ffffff';
                clone.style.color = '#000000';
                clone.style.height = 'auto'; // Altura automática
                
                // Container temporário para cálculo de altura
                const container = document.createElement('div');
                container.style.position = 'fixed';
                container.style.top = '-9999px';
                container.style.left = '0';
                container.style.zIndex = '-1';
                container.appendChild(clone);
                document.body.appendChild(container);

                // Calcula altura dinâmica em mm (aprox 1px = 0.264583mm)
                // Adicionamos um pequeno buffer para garantir que nada corte
                const heightPx = clone.offsetHeight || clone.scrollHeight;
                const heightMm = Math.ceil(heightPx * 0.264583) + 2; 

                const opt = {
                    margin:       0,
                    filename:     `recibo_${currentReceipt?.clientName || 'venda'}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false,
                        scrollY: 0,
                        windowWidth: document.documentElement.offsetWidth
                    },
                    // Define o formato com a altura calculada exata do conteúdo
                    jsPDF:        { unit: 'mm', format: [80, heightMm], orientation: 'portrait' } 
                };

                html2pdf().set(opt).from(clone).save().then(() => {
                    document.body.removeChild(container);
                    showToast("PDF Exportado com Sucesso!");
                }).catch(err => {
                    console.error("Erro PDF:", err);
                    if(document.body.contains(container)) document.body.removeChild(container);
                    showToast("Erro ao gerar PDF", "error");
                });
            };

            const startEdit = (sale) => { 
                setEditingId(sale.id); setDate(sale.date); setClientName(sale.clientName); setClientCpf(sale.clientCpf || ''); setClientPhone(sale.clientPhone || ''); setClientEmail(sale.clientEmail || ''); setClientDob(sale.clientDob || ''); setClientAddress(sale.clientAddress || ''); setClientNumber(sale.clientNumber || ''); setClientCity(sale.clientCity || ''); setClientZip(sale.clientZip || ''); setClientState(sale.clientState || ''); setClientNeighborhood(sale.clientNeighborhood || ''); setCategory(sale.category); 
                if (sale.items) setItems(sale.items); 
                if (sale.payments) setPaymentList(sale.payments); 
                setIsDateLocked(true); window.scrollTo({ top: 0, behavior: 'smooth' }); 
            };

            // --- CORREÇÃO AQUI: BLINDAGEM CONTRA NOME DE CLIENTE VAZIO ---
            const handleViewHistory = (client) => {
                // Se client.name for null/undefined, usa string vazia para evitar crash
                const cleanTargetCpf = client.cpf ? client.cpf.replace(/\D/g, '') : null;
                const targetName = (client.name || '').trim().toLowerCase(); 

                const clientSales = sales.filter(s => {
                    const saleCpf = s.clientCpf ? s.clientCpf.replace(/\D/g, '') : null;
                    // Protege s.clientName também
                    return (cleanTargetCpf && saleCpf && cleanTargetCpf === saleCpf) || ((s.clientName || '').trim().toLowerCase() === targetName);
                });
                setSelectedClientHistory({ client, history: clientSales }); setClientHistoryModalOpen(true);
            };

            const filteredSales = useMemo(() => {
                let f = sales;
                if (filterDate) f = f.filter(s => s.date === filterDate);
                if (searchTerm) {
                    const l = searchTerm.toLowerCase();
                    // Protege s.clientName
                    f = f.filter(s => (s.clientName || '').toLowerCase().includes(l) || s.items.some(i => i.description.toLowerCase().includes(l)));
                }
                return f.sort((a,b) => b.timestamp?.localeCompare(a.timestamp || '') || 0);
            }, [sales, searchTerm, filterDate]);

            // --- CORREÇÃO AQUI: BLINDAGEM CONTRA NOME DE CLIENTE VAZIO NA BUSCA ---
            const filteredClients = useMemo(() => {
                if (!clientSearchTerm) return clients;
                const l = clientSearchTerm.toLowerCase();
                // Protege c.name contra null/undefined
                return clients.filter(c => (c.name || '').toLowerCase().includes(l) || (c.cpf && c.cpf.includes(l)));
            }, [clients, clientSearchTerm]);

            const paginatedSales = useMemo(() => {
                const startIndex = (currentPage - 1) * itemsPerPage;
                return filteredSales.slice(startIndex, startIndex + itemsPerPage);
            }, [filteredSales, currentPage]);

            const totalPages = Math.ceil(filteredSales.length / itemsPerPage);

            const groupedSales = useMemo(() => {
                const source = paginatedSales;
                const g = {}; 
                source.forEach(s => { const k = groupBy === 'date' ? s.date : 'todas'; if (!g[k]) g[k] = []; g[k].push(s); });
                return Object.keys(g).sort((a,b) => a.localeCompare(b) * -1).map(k => ({ key: k, items: g[k], total: g[k].reduce((acc, s) => acc + (s.amountPaid || s.amount), 0) }));
            }, [paginatedSales, groupBy]);

            useEffect(() => setCurrentPage(1), [filterDate, searchTerm]);

            const handleLoginClick = (name) => { setSelectedUserForLogin(name); setLoginPasswordInput(''); setLoginModalOpen(true); };
            const performLogin = () => {
                if (loginPasswordInput === EMPLOYEES_CREDENTIALS[selectedUserForLogin]) {
                    setSettings({ employeeName: selectedUserForLogin }); setIsLoggedIn(true); setLoginModalOpen(false); showToast(`Bem-vindo, ${selectedUserForLogin}!`);
                } else showToast("Senha incorreta", "error");
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-100 to-slate-200 flex items-center justify-center p-4">
                        <ToastContainer toasts={toasts} removeToast={id => setToasts(p => p.filter(t => t.id !== id))} />
                        <div className="bg-white/80 backdrop-blur-xl rounded-[2.5rem] shadow-2xl border border-white/50 w-full max-w-md overflow-hidden animate-fade-in-up relative">
                            <div className="bg-gradient-to-br from-odoo-600 to-odoo-800 p-10 text-center text-white relative overflow-hidden">
                                <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -translate-y-1/2 translate-x-1/2 blur-3xl"></div>
                                <div className="relative z-10"><div className="inline-flex p-3 bg-white/10 rounded-2xl mb-4 backdrop-blur-sm shadow-lg border border-white/10 animate-float"><Icons.Store className="w-10 h-10 text-odoo-100" /></div><h1 className="text-3xl font-bold tracking-tight font-display mb-1">Miplace</h1><p className="text-odoo-200 text-sm font-medium uppercase tracking-widest opacity-90">Dompedro</p></div>
                            </div>
                            <div className="p-8 space-y-4">
                                <p className="text-center text-slate-500 text-sm font-medium mb-2">Selecione seu perfil para entrar</p>
                                {SELLERS_LIST.map(n => (<button key={n} onClick={() => handleLoginClick(n)} className="w-full py-4 px-6 bg-white border border-slate-200 rounded-2xl flex items-center justify-between hover:bg-slate-50 hover:border-odoo-300 hover:shadow-lg transition-all duration-300 group input-focus-effect active-scale relative overflow-hidden"><span className="font-bold text-slate-700 group-hover:text-odoo-700 relative z-10">{n}</span><div className="bg-slate-100 p-2 rounded-xl group-hover:bg-white transition-colors relative z-10 shadow-sm"><Icons.ChevronRight className="w-5 h-5 text-slate-400 group-hover:text-odoo-500"/></div></button>))}
                            </div>
                            {loginModalOpen && (<div className="absolute inset-0 bg-white/80 backdrop-blur-xl z-20 flex flex-col items-center justify-center p-8 animate-in fade-in zoom-in-95 duration-300"><h3 className="text-2xl font-bold text-slate-800 mb-2 font-display">Olá, {selectedUserForLogin}!</h3><p className="text-slate-500 mb-8 text-sm font-medium">Digite sua senha para acessar.</p><input type="password" value={loginPasswordInput} onChange={e => setLoginPasswordInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && performLogin()} className="w-full p-5 border border-slate-200 rounded-2xl text-center mb-8 font-bold outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all text-xl placeholder:font-normal bg-slate-50 focus:bg-white shadow-inner" placeholder="••••••" autoFocus /><div className="flex gap-4 w-full"><button onClick={() => setLoginModalOpen(false)} className="flex-1 p-4 bg-white border border-slate-200 text-slate-600 rounded-2xl font-bold hover:bg-slate-50 hover:shadow-md transition-all active-scale">Voltar</button><button onClick={performLogin} className="flex-1 p-4 bg-gradient-to-r from-odoo-600 to-odoo-700 text-white rounded-2xl font-bold hover:shadow-lg hover:shadow-odoo-500/30 transition-all active-scale">Entrar</button></div></div>)}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-24 print:bg-white print:pb-0">
                    <ToastContainer toasts={toasts} removeToast={id => setToasts(p => p.filter(t => t.id !== id))} />
                    <TaskAlertModal isOpen={alertModalOpen} onClose={() => setAlertModalOpen(false)} onGoToCalendar={() => { setAlertModalOpen(false); setCurrentView('calendar'); }} message={alertData.message} phase={alertData.phase} userName={settings.employeeName} />
                    <div className="bg-white/80 backdrop-blur-md border-b border-slate-200/60 sticky top-0 z-50 no-print transition-all duration-300">
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
                            <div className="flex items-center gap-4"><div className="bg-gradient-to-br from-odoo-500 to-odoo-600 p-2.5 rounded-xl shadow-lg shadow-odoo-500/20 text-white"><Icons.Store className="w-6 h-6" /></div><div><h1 className="font-bold text-xl leading-none text-slate-800 font-display">Miplace</h1><span className="font-medium text-xs text-slate-400 uppercase tracking-widest">{settings.employeeName}</span></div><div className="h-8 w-px bg-slate-200 mx-2"></div><a href="https://miplace.odoo.com/odoo/action-1581" target="_blank" className="p-2.5 bg-slate-100 hover:bg-slate-200 rounded-xl text-slate-600 transition-all shadow-sm active-scale" title="Lista de Preço"><Icons.Tag className="w-5 h-5" /></a></div>
                            <HeaderClock />
                            <div className="flex items-center gap-2 bg-slate-100 p-1.5 rounded-2xl border border-slate-200 relative">
                                <button onClick={() => setCurrentView(currentView === 'clients' ? 'dashboard' : 'clients')} className={`p-2.5 rounded-xl transition-all duration-300 ${currentView === 'clients' ? 'bg-white text-odoo-600 shadow-md ring-1 ring-black/5' : 'text-slate-500 hover:bg-white/50 hover:text-slate-700'}`} title="Carteira de Clientes">{currentView === 'clients' ? <Icons.Home className="w-5 h-5" /> : <Icons.Users className="w-5 h-5" />}</button>
                                <button onClick={() => setCurrentView(currentView === 'performance' ? 'dashboard' : 'performance')} className={`p-2.5 rounded-xl transition-all duration-300 ${currentView === 'performance' ? 'bg-white text-odoo-600 shadow-md ring-1 ring-black/5' : 'text-slate-500 hover:bg-white/50 hover:text-slate-700'}`} title="Desempenho"><Icons.BarChart className="w-5 h-5" /></button>
                                <button onClick={() => setCurrentView(currentView === 'calendar' ? 'dashboard' : 'calendar')} className={`p-2.5 rounded-xl transition-all duration-300 ${currentView === 'calendar' ? 'bg-white text-odoo-600 shadow-md ring-1 ring-black/5' : 'text-slate-500 hover:bg-white/50 hover:text-slate-700'}`} title="Calendário"><Icons.Calendar className="w-5 h-5" /></button>
                                <div className="w-px h-6 bg-slate-300 mx-1"></div>
                                <button onClick={() => setIsBackupOpen(true)} className="p-2.5 text-slate-500 hover:bg-slate-200 rounded-xl transition-all duration-300 hover:rotate-90 active-scale" title="Configurações"><Icons.Settings className="w-5 h-5" /></button>
                                
                                <div className="relative">
                                    <button 
                                        onClick={() => setIsHelpDropdownOpen(!isHelpDropdownOpen)} 
                                        className={`p-2.5 rounded-xl transition-all duration-300 active-scale ${isHelpDropdownOpen ? 'bg-slate-200 text-slate-800' : 'text-slate-500 hover:bg-slate-200'}`} 
                                        title="Links Úteis"
                                    >
                                        <Icons.HelpCircle className="w-5 h-5" />
                                    </button>
                                    
                                    {isHelpDropdownOpen && (
                                        <>
                                            <div className="fixed inset-0 z-[40]" onClick={() => setIsHelpDropdownOpen(false)}></div>
                                            <div className="absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-xl border border-slate-100 z-[50] overflow-hidden animate-in fade-in zoom-in-95 duration-200 origin-top-right">
                                                <div className="p-3 bg-slate-50 border-b border-slate-100 font-bold text-xs text-slate-500 uppercase tracking-wider flex items-center gap-2">
                                                    <Icons.HelpCircle className="w-4 h-4 text-odoo-500" /> Central de Ajuda
                                                </div>
                                                <div className="p-2 space-y-1 max-h-[60vh] overflow-y-auto custom-scrollbar">
                                                    {HELP_LINKS.map((link, idx) => {
                                                        const IconComp = Icons[link.icon] || Icons.Link;
                                                        return (
                                                            <a key={idx} href={link.url} target="_blank" rel="noopener noreferrer" className="flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 transition-colors text-xs font-medium text-slate-700 group border border-transparent hover:border-slate-100" onClick={() => setIsHelpDropdownOpen(false)}>
                                                                <div className="p-2 bg-white border border-slate-100 rounded-lg group-hover:border-odoo-200 group-hover:text-odoo-600 text-slate-400 transition-colors shadow-sm">
                                                                    <IconComp className="w-4 h-4" />
                                                                </div>
                                                                <span className="flex-1 leading-tight">{link.title}</span>
                                                                <Icons.ChevronRight className="w-4 h-4 text-slate-300 group-hover:text-slate-400" />
                                                            </a>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <button onClick={() => setLogoutModalOpen(true)} className="p-2.5 text-slate-500 hover:bg-red-50 hover:text-red-500 rounded-xl transition-all duration-300 active-scale" title="Sair"><Icons.LogOut className="w-5 h-5" /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-6xl mx-auto p-6 space-y-8 animate-fade-in-up">
                        {currentView === 'calendar' ? (
                            <SimpleCalendar routineState={routineState} toggleRoutine={toggleRoutine} />
                        ) : currentView === 'performance' ? (
                            <div className="space-y-8">
                                <div className="glass rounded-[2rem] shadow-xl border border-white p-8">
                                    <h2 className="text-2xl font-bold text-slate-800 mb-8 flex items-center gap-3 font-display"><div className="p-2.5 bg-gradient-to-br from-odoo-50 to-odoo-100 rounded-xl text-odoo-600 shadow-sm"><Icons.BarChart className="w-6 h-6"/></div>Desempenho de Vendas <span className="text-slate-400 font-normal text-lg">• {settings.employeeName}</span></h2>
                                    <div className="bg-gradient-to-br from-slate-800 to-slate-950 rounded-[2rem] p-10 text-white mb-8 shadow-2xl shadow-slate-900/20 relative overflow-hidden group hover:scale-[1.01] transition-transform duration-500">
                                        <div className="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-odoo-500/20 to-purple-500/20 rounded-full -translate-y-1/3 translate-x-1/4 blur-3xl group-hover:scale-110 transition-transform duration-1000"></div>
                                        <div className="absolute bottom-0 left-0 w-64 h-64 bg-blue-500/10 rounded-full translate-y-1/3 -translate-x-1/4 blur-3xl"></div>
                                        {(() => {
                                            const isManager = settings.employeeName === "Davison Cerqueira";
                                            const myTarget = isManager ? GOAL_MANAGER : GOAL_SELLERS;
                                            const currentMonth = new Date().getMonth();
                                            const currentYear = new Date().getFullYear();
                                            const relevantSales = sales.filter(s => {
                                                const d = new Date(s.date + 'T00:00:00');
                                                if(d.getMonth() !== currentMonth || d.getFullYear() !== currentYear) return false;
                                                return isManager ? true : s.employeeName === settings.employeeName;
                                            });
                                            const unitsSold = relevantSales.reduce((acc, s) => {
                                                const eligibleItems = (s.items || []).filter(i => ELIGIBLE_FOR_GOAL.includes(i.type) && i.unitPrice > 0);
                                                return acc + eligibleItems.reduce((sum, i) => sum + i.quantity, 0);
                                            }, 0);
                                            const progress = Math.min((unitsSold / myTarget) * 100, 100);
                                            const isGoalReached = unitsSold >= myTarget;
                                            const potentialCommission = isGoalReached ? (unitsSold * COMMISSION_PER_UNIT) : 0;
                                            return (
                                                <div className="relative z-10 flex flex-col md:flex-row justify-between items-end gap-8">
                                                    <div className="flex-1 w-full">
                                                        <div className="flex justify-between items-start mb-8"><div><h3 className="text-sm font-bold text-slate-400 uppercase tracking-[0.2em] mb-3">Meta de Aparelhos</h3><div className="flex items-baseline gap-3"><p className="text-6xl font-black tracking-tighter bg-gradient-to-b from-white to-slate-400 bg-clip-text text-transparent drop-shadow-sm">{unitsSold}</p><span className="text-2xl font-medium text-slate-500">/ {myTarget} <span className="text-sm">un</span></span></div></div><div className="text-right bg-white/5 p-5 rounded-2xl backdrop-blur-md border border-white/10 shadow-xl"><p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Comissão Extra</p><p className={`text-3xl font-black ${isGoalReached ? 'text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 drop-shadow-[0_0_10px_rgba(252,211,77,0.3)]' : 'text-slate-600'}`}>R$ {formatCurrency(potentialCommission)}</p></div></div>
                                                        <div className="w-full bg-slate-800/50 rounded-full h-5 mb-5 overflow-hidden border border-white/5 shadow-inner p-0.5"><div className={`h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-2 shadow-lg relative overflow-hidden ${isGoalReached ? 'bg-gradient-to-r from-yellow-500 to-amber-300 animate-pulse-slow' : 'bg-gradient-to-r from-odoo-500 to-cyan-400'}`} style={{ width: `${progress}%` }}><div className="absolute inset-0 bg-white/20 w-full h-full skew-x-12 -translate-x-full animate-[shimmer_2s_infinite]"></div>{progress > 8 && <span className="text-[10px] font-bold text-slate-900 drop-shadow-sm z-10">{Math.round(progress)}%</span>}</div></div>
                                                        <div className="flex items-center gap-4"><div className={`p-2.5 rounded-xl shadow-lg ${isGoalReached ? 'bg-yellow-500/20 text-yellow-400 ring-1 ring-yellow-500/30' : 'bg-odoo-500/20 text-odoo-400 ring-1 ring-odoo-500/30'}`}>{isGoalReached ? <Icons.Trophy className="w-6 h-6 animate-bounce" /> : <Icons.BarChart className="w-6 h-6" />}</div><p className="text-base font-medium text-slate-300">{isGoalReached ? "Parabéns! Você bateu a meta e já está acumulando comissão!" : `Faltam apenas ${Math.max(0, myTarget - unitsSold)} unidades para desbloquear sua comissão extra. Vamos lá!`}</p></div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                            {(() => {
                                                const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                const today = new Date().toISOString().split('T')[0];
                                                const currentMonth = new Date().getMonth();
                                                const currentYear = new Date().getFullYear();
                                                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                                                const salesToday = mySales.filter(s => s.date === today).reduce((acc, s) => acc + (s.amountPaid || s.amount), 0);
                                                const salesMonth = mySales.filter(s => { const d = new Date(s.date + 'T00:00:00'); return d.getMonth() === currentMonth && d.getFullYear() === currentYear; });
                                                const totalMonth = salesMonth.reduce((acc, s) => acc + (s.amountPaid || s.amount), 0);
                                                
                                                // Novos KPIS Calculados
                                                const countSalesMonth = salesMonth.length;
                                                const totalDiscountMonth = salesMonth.reduce((acc, s) => acc + (s.discount || 0), 0);
                                                const myClients = clients.filter(c => {
                                                    if (!c.createdAt || c.createdBy !== settings.employeeName) return false;
                                                    const d = new Date(c.createdAt);
                                                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                                                });
                                                const newClientsCount = myClients.length;
                                                const avgTicket = countSalesMonth > 0 ? totalMonth / countSalesMonth : 0;

                                                return (
                                                    <>
                                                    <div className="p-6 rounded-[1.5rem] border border-blue-100 bg-blue-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-blue-600 uppercase tracking-wider">Vendas Hoje</p><div className="p-1.5 rounded-lg bg-white/50 text-blue-600"><Icons.DollarSign className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">{formatCurrency(salesToday)}</p></div>
                                                    <div className="p-6 rounded-[1.5rem] border border-emerald-100 bg-emerald-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-emerald-600 uppercase tracking-wider">Total Mês</p><div className="p-1.5 rounded-lg bg-white/50 text-emerald-600"><Icons.BarChart className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">{formatCurrency(totalMonth)}</p></div>
                                                    <div className="p-6 rounded-[1.5rem] border border-violet-100 bg-violet-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-violet-600 uppercase tracking-wider">Ticket Médio</p><div className="p-1.5 rounded-lg bg-white/50 text-violet-600"><Icons.Tag className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">{formatCurrency(avgTicket)}</p></div>
                                                    
                                                    <div className="p-6 rounded-[1.5rem] border border-orange-100 bg-orange-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-orange-600 uppercase tracking-wider">Qtd Vendas</p><div className="p-1.5 rounded-lg bg-white/50 text-orange-600"><Icons.Receipt className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">{countSalesMonth}</p></div>
                                                    <div className="p-6 rounded-[1.5rem] border border-indigo-100 bg-indigo-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-indigo-600 uppercase tracking-wider">Novos Cadastros</p><div className="p-1.5 rounded-lg bg-white/50 text-indigo-600"><Icons.UserPlus className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">{newClientsCount}</p></div>
                                                    <div className="p-6 rounded-[1.5rem] border border-rose-100 bg-rose-50/60 hover:shadow-xl hover:-translate-y-1 transition-all duration-300 group"><div className="flex justify-between items-start mb-2"><p className="text-xs font-bold text-rose-600 uppercase tracking-wider">Total Descontos</p><div className="p-1.5 rounded-lg bg-white/50 text-rose-600"><Icons.AlertTriangle className="w-4 h-4"/></div></div><p className="text-3xl font-black text-slate-800 tracking-tight">-{formatCurrency(totalDiscountMonth)}</p></div>
                                                    </>
                                                );
                                            })()}
                                    </div>
                                    
                                    {/* GRÁFICO MENSAL - NOVO */}
                                    <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-500 bg-white mb-8">
                                        <h3 className="font-bold text-xs text-slate-400 uppercase mb-8 tracking-widest flex items-center gap-2"><div className="w-2 h-2 bg-odoo-500 rounded-full"></div> Vendas do Mês (Gráfico Completo)</h3>
                                        <div className="h-64 flex items-end gap-1 justify-between px-2 overflow-x-auto">
                                            {(() => {
                                                const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                const date = new Date();
                                                const year = date.getFullYear();
                                                const month = date.getMonth();
                                                const days = new Date(year, month + 1, 0).getDate();
                                                const monthData = [];
                                                
                                                for(let i=1; i<=days; i++) {
                                                    const dayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                                                    const val = mySales.filter(s => s.date === dayStr).reduce((acc, s) => acc + (s.amountPaid || s.amount), 0);
                                                    monthData.push({ day: i, val });
                                                }
                                                const maxVal = Math.max(...monthData.map(d => d.val), 100);

                                                return monthData.map(d => (
                                                    <div key={d.day} className="flex flex-col items-center flex-1 group/bar relative h-full justify-end min-w-[20px]">
                                                        <div className={`w-full rounded-t-sm transition-all duration-300 relative ${d.val > 0 ? 'bg-odoo-300 hover:bg-odoo-500' : 'bg-slate-100'}`} style={{ height: `${Math.max((d.val / maxVal) * 100, 2)}%` }}>
                                                            {d.val > 0 && (
                                                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] font-bold px-1.5 py-0.5 rounded opacity-0 group-hover/bar:opacity-100 transition-opacity z-10 whitespace-nowrap">
                                                                    {Math.round(d.val)}
                                                                </div>
                                                            )}
                                                        </div>
                                                        <span className="text-[9px] text-slate-300 mt-1">{d.day}</span>
                                                    </div>
                                                ));
                                            })()}
                                        </div>
                                    </div>

                                    {/* ... (Gráficos Anteriores) ... */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-500 bg-white group">
                                            <h3 className="font-bold text-xs text-slate-400 uppercase mb-8 tracking-widest flex items-center gap-2"><div className="w-2 h-2 bg-odoo-500 rounded-full animate-pulse"></div> Últimos 7 Dias</h3>
                                            <div className="h-56 flex items-end gap-3 justify-between px-2">
                                                {(() => {
                                                    const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                    const last7Days = Array.from({length: 7}, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return d.toISOString().split('T')[0]; });
                                                    const data = last7Days.map(date => { const val = mySales.filter(s => s.date === date).reduce((acc, s) => acc + (s.amountPaid || s.amount), 0); return { date, val }; });
                                                    const maxVal = Math.max(...data.map(d => d.val), 1); 
                                                    return data.map(d => {
                                                        const [year, month, day] = d.date.split('-');
                                                        const heightPercent = Math.max((d.val / maxVal) * 100, 4);
                                                        return (<div key={d.date} className="flex flex-col items-center flex-1 group/bar relative h-full justify-end"><div className="w-full bg-odoo-50 rounded-t-xl group-hover/bar:bg-gradient-to-t group-hover/bar:from-odoo-600 group-hover/bar:to-odoo-400 transition-all duration-500 relative overflow-hidden group-hover/bar:shadow-[0_0_15px_rgba(14,165,233,0.3)]" style={{ height: `${heightPercent}%` }}><div className="absolute inset-0 bg-white/20 translate-y-full group-hover/bar:translate-y-0 transition-transform duration-700"></div></div><div className="absolute -top-12 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] font-bold px-3 py-1.5 rounded-lg opacity-0 group-hover/bar:opacity-100 transition-all duration-300 transform group-hover/bar:-translate-y-1 shadow-xl z-20 whitespace-nowrap">{formatCurrency(d.val)}<div className="absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-2 h-2 bg-slate-800 rotate-45"></div></div><span className="text-[10px] font-bold text-slate-300 mt-3 group-hover/bar:text-odoo-600 transition-colors">{day}/{month}</span></div>);
                                                    });
                                                })()}
                                            </div>
                                        </div>
                                        <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-500 bg-white">
                                            <h3 className="font-bold text-xs text-slate-400 uppercase mb-6 tracking-widest flex items-center gap-2"><div className="w-2 h-2 bg-purple-500 rounded-full"></div> Top Produtos (Mês)</h3>
                                            <div className="space-y-4 max-h-56 overflow-y-auto pr-2 custom-scrollbar">
                                                {(() => {
                                                    const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                    const currentMonth = new Date().getMonth();
                                                    const currentYear = new Date().getFullYear();
                                                    const productCount = {};
                                                    mySales.forEach(s => { const d = new Date(s.date + 'T00:00:00'); if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { (s.items || []).forEach(i => { const key = i.description; productCount[key] = (productCount[key] || 0) + i.quantity; }); } });
                                                    const sortedProducts = Object.entries(productCount).sort(([,a], [,b]) => b - a).slice(0, 5);
                                                    if (sortedProducts.length === 0) return <p className="text-sm text-slate-400 italic text-center py-10">Nenhuma venda registrada neste mês.</p>;
                                                    return sortedProducts.map(([name, qty], idx) => (<div key={name} className="flex justify-between items-center text-sm p-4 hover:bg-slate-50 rounded-2xl transition-colors group border border-transparent hover:border-slate-100"><div className="flex items-center gap-4 overflow-hidden"><span className={`flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-xl text-xs font-black shadow-sm ${idx === 0 ? 'bg-yellow-100 text-yellow-600' : idx === 1 ? 'bg-slate-100 text-slate-600' : idx === 2 ? 'bg-orange-100 text-orange-600' : 'bg-slate-50 text-slate-400'}`}>{idx + 1}</span><span className="truncate font-medium text-slate-600 group-hover:text-slate-900 transition-colors">{name}</span></div><span className="font-bold text-odoo-600 bg-odoo-50 px-3 py-1.5 rounded-lg text-xs shadow-sm">{qty} un</span></div>));
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mt-8">
                                        <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-300 md:col-span-1 bg-white">
                                            <h3 className="font-bold text-xs text-slate-400 uppercase mb-6 tracking-widest">Formas de Pagamento</h3>
                                            <div className="space-y-5">
                                                {(() => {
                                                    const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                    const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
                                                    const paymentStats = {}; let totalPayments = 0;
                                                    mySales.forEach(s => { const d = new Date(s.date + 'T00:00:00'); if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { (s.payments || []).forEach(p => { if (p.amount > 0) { paymentStats[p.method] = (paymentStats[p.method] || 0) + p.amount; totalPayments += p.amount; } }); } });
                                                    const sortedPayments = Object.entries(paymentStats).sort(([,a], [,b]) => b - a);
                                                    if (sortedPayments.length === 0) return <p className="text-xs text-slate-400 italic">Sem dados financeiros.</p>;
                                                    return sortedPayments.map(([method, amount]) => { const percent = Math.round((amount / totalPayments) * 100) || 0; return (<div key={method} className="space-y-2 group"><div className="flex justify-between text-xs font-bold text-slate-500 group-hover:text-slate-700 transition-colors"><span>{method}</span><span>{percent}%</span></div><div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden p-0.5"><div className="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full rounded-full transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(16,185,129,0.4)]" style={{ width: `${percent}%` }}></div></div><div className="text-[10px] text-right text-slate-400 font-mono font-medium">{formatCurrency(amount)}</div></div>); });
                                                })()}
                                            </div>
                                        </div>
                                        <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-300 md:col-span-1 bg-white">
                                            <h3 className="font-bold text-xs text-slate-400 uppercase mb-6 tracking-widest">Vendas por Tipo</h3>
                                            <div className="space-y-5">
                                                {(() => {
                                                    const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                    const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
                                                    const typeStats = {}; let totalItems = 0;
                                                    mySales.forEach(s => { const d = new Date(s.date + 'T00:00:00'); if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { (s.items || []).forEach(i => { if (i.quantity > 0) { typeStats[i.type] = (typeStats[i.type] || 0) + i.quantity; totalItems += i.quantity; } }); } });
                                                    const sortedTypes = Object.entries(typeStats).sort(([,a], [,b]) => b - a).slice(0, 6);
                                                    if (sortedTypes.length === 0) return <p className="text-xs text-slate-400 italic">Sem itens vendidos.</p>;
                                                    return sortedTypes.map(([type, qty]) => { const percent = Math.round((qty / totalItems) * 100) || 0; return (<div key={type} className="space-y-2 group"><div className="flex justify-between text-xs font-bold text-slate-500 group-hover:text-slate-700 transition-colors"><span>{type}</span><span>{qty} un</span></div><div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden p-0.5"><div className="bg-gradient-to-r from-blue-400 to-indigo-600 h-full rounded-full transition-all duration-1000 group-hover:shadow-[0_0_10px_rgba(79,70,229,0.4)]" style={{ width: `${percent}%` }}></div></div></div>); });
                                                })()}
                                            </div>
                                        </div>
                                        <div className="border border-slate-100 rounded-[2rem] p-8 hover:shadow-xl transition-all duration-300 md:col-span-1 bg-white">
                                            <h3 className="font-bold text-xs text-slate-400 uppercase mb-6 tracking-widest">Status das Vendas</h3>
                                            <div className="space-y-5">
                                                {(() => {
                                                    const mySales = sales.filter(s => s.employeeName === settings.employeeName);
                                                    const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
                                                    const catStats = {}; let totalCount = 0;
                                                    mySales.forEach(s => { const d = new Date(s.date + 'T00:00:00'); if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) { catStats[s.category] = (catStats[s.category] || 0) + 1; totalCount++; } });
                                                    const sortedCats = Object.entries(catStats).sort(([,a], [,b]) => b - a);
                                                    if (sortedCats.length === 0) return <p className="text-xs text-slate-400 italic">Sem dados.</p>;
                                                    return sortedCats.map(([cat, count]) => { const percent = Math.round((count / totalCount) * 100) || 0; const isCrediario = cat.includes('Crediario'); const isVenda = cat.includes('Venda'); const bgGradient = isCrediario ? 'from-orange-400 to-red-500' : isVenda ? 'from-teal-400 to-emerald-600' : 'from-slate-400 to-slate-600'; return (<div key={cat} className="space-y-2 group"><div className="flex justify-between text-xs font-bold text-slate-500 group-hover:text-slate-700 transition-colors"><span>{cat}</span><span>{percent}%</span></div><div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden p-0.5"><div className={`h-full rounded-full bg-gradient-to-r ${bgGradient} transition-all duration-1000`} style={{ width: `${percent}%` }}></div></div></div>); });
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : currentView === 'clients' ? (
                            <div className="glass rounded-[2rem] shadow-xl border border-white overflow-hidden fade-in-up">
                                <div className="p-8 border-b border-white/50 flex justify-between items-center gap-4 bg-gradient-to-r from-white to-slate-50"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-3 font-display"><div className="p-2.5 bg-white rounded-xl shadow-lg shadow-odoo-100 text-odoo-600"><Icons.User className="w-6 h-6"/></div>Carteira de Clientes</h2><div className="relative group"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 group-hover:text-odoo-500 transition-colors" /><input type="text" placeholder="Buscar cliente..." value={clientSearchTerm} onChange={e => setClientSearchTerm(e.target.value)} className="w-72 pl-12 pr-4 py-3.5 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 focus:bg-white bg-white/50 transition-all font-medium"/></div></div>
                                <div className="overflow-x-auto"><table className="w-full text-left"><thead className="bg-slate-50/50 border-b border-slate-200/60 text-slate-400 font-bold text-xs uppercase tracking-widest"><tr><th className="p-5 pl-8">Nome</th><th className="p-5">Contato</th><th className="p-5">Vendedor</th><th className="p-5 text-right pr-8">Ações</th></tr></thead><tbody className="divide-y divide-slate-100">{filteredClients.map(c => (<tr key={c.id} className="hover:bg-odoo-50/40 transition-colors text-sm text-slate-600 group"><td className="p-5 pl-8"><div className="font-bold text-slate-800 leading-tight text-base group-hover:text-odoo-700 transition-colors">{c.name}</div><div className="text-xs text-slate-400 mt-1 font-mono">{c.cpf}</div></td><td className="p-5"><div className="flex items-center gap-2"><span>{c.phone}</span>{c.phone && (<button onClick={() => window.open(`https://wa.me/55${c.phone.replace(/\D/g, '')}`, '_blank')} className="text-slate-300 hover:text-green-500 transition-all hover:scale-110 active:scale-95" title="Chamar no WhatsApp"><Icons.WhatsApp className="w-4 h-4" /></button>)}</div><div className="text-[10px] italic text-slate-400">{c.email}</div></td><td className="p-5"><span className="bg-slate-100 text-slate-500 px-3 py-1 rounded-full text-xs font-bold border border-slate-200">{c.createdBy || '-'}</span></td><td className="p-5 text-right pr-8"><button onClick={() => handleViewHistory(c)} className="px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold mr-2 hover:bg-slate-50 hover:border-slate-300 hover:shadow-sm transition-all active-scale">Histórico</button><button onClick={() => handleOpenClientData(c)} className="px-4 py-2 bg-purple-50 border border-purple-200 text-purple-600 rounded-xl text-xs font-bold mr-2 hover:bg-purple-100 hover:border-purple-300 hover:shadow-sm transition-all active-scale">Dados</button><button onClick={() => { fillClientData(c); setCurrentView('dashboard'); window.scrollTo(0,0); }} className="px-4 py-2 bg-gradient-to-r from-odoo-500 to-odoo-600 text-white rounded-xl text-xs font-bold hover:shadow-lg hover:shadow-odoo-500/30 transition-all active-scale">Nova Venda</button></td></tr>))}</tbody></table></div>
                            </div>
                        ) : (
                            <>
                                <div className="glass rounded-[2.5rem] shadow-xl border border-white overflow-hidden no-print fade-in-up">
                                    <div className={`h-2 w-full bg-gradient-to-r ${editingId ? 'from-orange-400 via-red-500 to-orange-400 animate-pulse' : 'from-odoo-400 via-odoo-600 to-odoo-400'}`}></div>
                                    <div className="p-10 space-y-10">
                                        <form onSubmit={handleSubmit} className="space-y-10">
                                            <div className="grid grid-cols-1 md:grid-cols-12 gap-8">
                                                <div className="md:col-span-6 space-y-3"><label className="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">Data do Lançamento</label><div className="relative group"><DateInput required value={date} onChange={e => { setDate(e.target.value); setIsDateLocked(true); }} className={`w-full p-5 bg-slate-50 border-0 rounded-2xl outline-none text-lg font-bold text-slate-700 focus:ring-4 focus:ring-odoo-100 focus:bg-white transition-all ${isDateLocked ? 'opacity-60 cursor-not-allowed' : ''}`} />{isDateLocked && <div className="absolute inset-0 z-10 cursor-lock rounded-2xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-slate-100/10 backdrop-blur-[1px]" onClick={() => setDateLockModalOpen(true)}><Icons.Lock className="w-6 h-6 text-slate-400"/></div>}</div></div>
                                                <div className="md:col-span-6 space-y-3"><label className="text-[11px] font-bold text-slate-400 uppercase tracking-widest ml-1">Categoria</label><div className="relative"><select required value={category} onChange={e => setCategory(e.target.value)} className="w-full p-5 bg-slate-50 border-0 rounded-2xl outline-none text-lg font-bold text-slate-700 focus:ring-4 focus:ring-odoo-100 focus:bg-white transition-all hover:bg-slate-100 appearance-none cursor-pointer"><option value="">Selecione...</option>{CATEGORIES_LIST.map(c => <option key={c} value={c}>{c}</option>)}</select><div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><Icons.ChevronLeft className="-rotate-90 w-5 h-5"/></div></div></div>
                                                
                                                <div className="md:col-span-12 border border-white bg-gradient-to-b from-white to-slate-50/50 rounded-[2rem] p-8 shadow-sm">
                                                    <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-slate-700 flex items-center gap-3 font-display"><div className="p-2.5 bg-white rounded-xl shadow-lg shadow-odoo-100 text-odoo-500"><Icons.User className="w-6 h-6"/></div> Dados do Cliente</h3><div className="flex gap-3"><button type="button" onClick={() => { setClientSearchTerm(''); setClientSearchModalOpen(true); }} className="px-5 py-3 bg-white text-slate-600 rounded-xl text-xs font-bold hover:shadow-lg transition-all active:scale-95 border border-slate-100">Importar</button><button type="button" onClick={handleSaveClient} className="px-5 py-3 bg-slate-800 text-white rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg shadow-slate-500/20 hover:bg-slate-900 transition-all active:scale:95"><Icons.Save className="w-4 h-4"/> Salvar Cadastro</button></div></div>
                                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-5">
                                                        <div className="md:col-span-8 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Nome Completo</label><input type="text" required placeholder="Nome do Cliente" value={clientName} onChange={e => setClientName(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-4 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">CPF</label><input type="text" placeholder="000.000.000-00" value={clientCpf} onChange={handleCpfChange} className="w-full p-4 border border-slate-200 rounded-2xl text-sm font-mono outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">CEP</label><input type="text" placeholder="00000-000" value={clientZip} onChange={handleZipChange} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-5 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Endereço</label><input type="text" placeholder="Rua, Av..." value={clientAddress} onChange={e => setClientAddress(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Nº</label><input type="text" placeholder="123" value={clientNumber} onChange={e => setClientNumber(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-3 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Bairro</label><input type="text" placeholder="Bairro" value={clientNeighborhood} onChange={e => setClientNeighborhood(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-4 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Município</label><input type="text" placeholder="Cidade" value={clientCity} onChange={e => setClientCity(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">UF</label><select value={clientState} onChange={e => setClientState(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium bg-white"><option value="">UF</option>{UF_LIST.map(uf => <option key={uf} value={uf}>{uf}</option>)}</select></div>
                                                        <div className="md:col-span-3 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Telefone / Zap</label><input type="text" placeholder="(00) 00000-0000" value={clientPhone} onChange={e => setClientPhone(maskPhone(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-3 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">Nascimento</label><input type="text" placeholder="dd/mm/aaaa" value={clientDob} onChange={e => setClientDob(maskDateStrict(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                        <div className="md:col-span-12 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1">E-mail</label><input type="email" placeholder="cliente@email.com" value={clientEmail} onChange={e => setClientEmail(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium" /></div>
                                                    </div>
                                                </div>

                                                <div className="md:col-span-12 border border-white bg-gradient-to-b from-white to-slate-50/50 rounded-[2rem] p-8 shadow-sm">
                                                    <h3 className="text-xl font-bold text-slate-700 mb-6 flex items-center gap-3 font-display"><div className="p-2.5 bg-white rounded-xl shadow-lg shadow-odoo-100 text-odoo-500"><Icons.Package className="w-6 h-6"/></div> Itens da Venda</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                                                        <div className="md:col-span-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Qtd</label><input type="number" min="1" value={newItemQty} onChange={e => setNewItemQty(parseInt(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm text-center font-bold outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Tipo</label><select value={newItemType} onChange={e => setNewItemType(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm bg-white outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all"><option value="">Selecione</option>{PRODUCT_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                                        <div className="md:col-span-5"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Descrição</label><input type="text" placeholder="Produto" value={newItemDesc} onChange={e => setNewItemDesc(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">RAM/Store</label><select value={newItemRam} onChange={e => setNewItemRam(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm bg-white outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all"><option value="">Selecione</option>{RAM_STORAGE_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}</select></div>
                                                        <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Cor</label><input type="text" placeholder="Cor" value={newItemColor} onChange={e => setNewItemColor(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className="md:col-span-3"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">IMEI</label><input type="text" placeholder="IMEI" value={newItemImei} onChange={e => setNewItemImei(maskIMEI(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm font-mono outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Financiado</label><select value={newItemFinanced} onChange={e => setNewItemFinanced(e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm bg-white outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all"><option value="Não">Não</option><option value="Sim">Sim</option></select></div>
                                                        {category === 'Troca' && (<div className="md:col-span-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Movimento</label><select value={exchangeAction} onChange={e => setExchangeAction(e.target.value)} className="w-full p-4 border-2 border-slate-200 rounded-2xl text-sm bg-white font-bold text-slate-700 outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all"><option value="out">Cliente Leva (Novo)</option><option value="in">Cliente Devolve (Antigo)</option></select></div>)}
                                                        <div className="md:col-span-3"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Preço Unit</label><input type="text" placeholder="0,00" value={newItemPrice} onChange={handleItemPriceChange} className="w-full p-4 border border-slate-200 rounded-2xl text-sm text-right font-bold outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className={category === 'Troca' ? "md:col-span-1" : "md:col-span-2"}><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">% Desc</label><input type="text" placeholder="%" value={newItemDiscountPercent} onChange={handlePercentChange} className="w-full p-4 border border-slate-200 rounded-2xl text-sm text-center outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className={category === 'Troca' ? "md:col-span-1" : "md:col-span-2"}><label className="text-[10px] font-bold text-slate-400 uppercase ml-1 mb-1 block">Desc R$</label><input type="text" placeholder="0,00" value={newItemDiscount} onChange={handleDiscountValChange} className="w-full p-4 border border-slate-200 rounded-2xl text-sm text-right text-red-500 outline-none focus:ring-4 focus:ring-red-100 focus:border-red-200 transition-all" /></div>
                                                        <button type="button" onClick={handleAddItem} className="md:col-span-12 bg-gradient-to-r from-odoo-600 to-odoo-700 text-white font-bold rounded-2xl py-4 text-sm hover:shadow-lg hover:shadow-odoo-500/20 active:scale-[0.98] transition-all uppercase tracking-wide">Adicionar Item à Lista</button>
                                                    </div>
                                                    {items.length > 0 && (<div className="overflow-hidden border border-slate-200 rounded-3xl bg-white shadow-sm"><table className="w-full text-left text-sm"><thead className="bg-slate-50 border-b border-slate-200 text-xs text-slate-500 uppercase font-bold tracking-wider"><tr><th className="p-4 text-center">Qtd</th><th className="p-4 text-left">Produto Detalhado</th><th className="p-4 text-right">Preço</th><th className="p-4 text-right">Desconto</th><th className="p-4 text-right">Total</th><th className="p-4 w-12"></th></tr></thead><tbody className="divide-y divide-slate-100">{items.map(i => (<tr key={i.id} className={`hover:bg-slate-50 transition-colors ${i.unitPrice < 0 ? 'bg-red-50/50' : ''}`}><td className="p-4 font-bold text-center text-slate-600">{i.quantity}</td><td className="p-4"><div className="font-bold text-slate-700">{i.type} - {i.description}</div><div className="text-xs text-slate-400 mt-1 flex gap-2 font-medium">{i.ram_storage && <span className="bg-slate-100 px-2 py-0.5 rounded-md border border-slate-200">{i.ram_storage}</span>}{i.color && <span className="bg-slate-100 px-2 py-0.5 rounded-md border border-slate-200">{i.color}</span>}<span className="bg-slate-100 px-2 py-0.5 rounded-md border border-slate-200">Finan: {i.financed}</span></div></td><td className="p-4 text-right font-mono text-slate-600">{formatCurrency(i.unitPrice)}</td><td className="p-4 text-right font-mono text-red-500">-{formatCurrency(i.discount)}</td><td className="p-4 text-right font-mono font-bold text-slate-800">{formatCurrency((i.unitPrice * i.quantity) - i.discount)}</td><td className="p-4 text-center"><button type="button" onClick={() => handleRemoveItem(i.id)} className="p-2 hover:bg-red-50 text-slate-300 hover:text-red-500 rounded-xl transition-colors active-scale"><Icons.Trash2 className="w-5 h-5"/></button></td></tr>))}</tbody></table></div>)}
                                                </div>

                                                <div className="md:col-span-12 border border-white bg-gradient-to-b from-white to-slate-50/50 rounded-[2rem] p-8 shadow-sm">
                                                    <h3 className="text-xl font-bold text-slate-700 mb-6 flex items-center gap-3 font-display"><div className="p-2.5 bg-white rounded-xl shadow-lg shadow-odoo-100 text-odoo-500"><Icons.DollarSign className="w-6 h-6"/></div> Pagamento</h3>
                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8"><div className="bg-white p-4 border border-slate-200 rounded-3xl shadow-sm"><p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Subtotal</p><p className="text-xl font-bold text-slate-700">{formatCurrency(totalAmount)}</p></div><div className="bg-white p-4 border border-slate-200 rounded-3xl shadow-sm"><p className="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Descontos</p><p className="text-xl font-bold text-red-500">-{formatCurrency(totalDiscount)}</p></div><div className="bg-odoo-50 p-4 border border-odoo-200 rounded-3xl shadow-inner"><p className="text-xs font-bold text-odoo-600 uppercase tracking-widest mb-1">A Pagar</p><p className="text-3xl font-black text-odoo-700 tracking-tight">{formatCurrency(finalTotal)}</p></div></div>
                                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end mb-6">
                                                        <div className={currentPaymentMethod === 'Credito Parcelado' ? "md:col-span-3" : "md:col-span-3"}><label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Forma</label><select value={currentPaymentMethod} onChange={e => setCurrentPaymentMethod(e.target.value)} className="w-full p-3 border border-slate-200 rounded-2xl text-sm bg-white tracking-tight outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium"><option value="">Selecione...</option>{PAYMENT_METHODS.map(m => <option key={m} value={m}>{m}</option>)}{(category === 'Devolução' || category === 'Troca') && (<><option value="Devolução Dinheiro">Devolução Dinheiro</option><option value="Devolução Pix">Devolução Pix</option><option value="Devolução Estorno Cartão">Devolução Estorno Cartão</option></>)}</select></div>
                                                        {currentPaymentMethod === 'Credito Parcelado' && (<div className="md:col-span-2"><label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Parc.</label><select value={currentInstallments} onChange={e => setCurrentInstallments(e.target.value)} className="w-full p-3 border border-slate-200 rounded-2xl text-sm bg-white outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium"><option value="">Qtd</option>{[2,3,4,5,6,7,8,9,10,11,12].map(i => <option key={i} value={`${i}x`}>{i}x</option>)}</select></div>)}
                                                        <div className={currentPaymentMethod === 'Credito Parcelado' ? "md:col-span-2" : "md:col-span-3"}><label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Tipo</label><select value={currentPaymentType} onChange={e => setCurrentPaymentType(e.target.value)} className="w-full p-3 border border-slate-200 rounded-2xl text-sm bg-white tracking-tight outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all font-medium"><option value="">Selecione...</option>{PAYMENT_TYPES.map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                                        <div className="md:col-span-3"><label className="text-xs font-bold text-slate-500 uppercase ml-1 mb-1 block">Valor</label><input type="text" value={currentPaymentAmount} onChange={handleCurrentPaymentAmountChange} className="w-full p-3 border border-slate-200 rounded-2xl text-sm text-right font-bold bg-white outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all" /></div>
                                                        <div className={currentPaymentMethod === 'Credito Parcelado' ? "md:col-span-2" : "md:col-span-3"}><button type="button" onClick={handleAddPayment} className="w-full bg-emerald-500 text-white font-bold rounded-2xl py-3.5 text-sm hover:bg-emerald-600 shadow-lg shadow-emerald-500/20 active-scale whitespace-nowrap transition-all uppercase tracking-wide">Add Pgto</button></div>
                                                    </div>
                                                    <div className="bg-white border border-slate-200 rounded-3xl overflow-hidden shadow-sm">
                                                        <table className="w-full text-left text-xs"><thead className="bg-slate-50 border-b border-slate-100 text-slate-400 font-bold uppercase tracking-wider"><tr><th className="p-4">Forma</th><th className="p-4 text-right">Valor</th><th className="p-4 w-10"></th></tr></thead><tbody>{paymentList.map(p => { const styles = getPaymentStyles(p.type); return (<tr key={p.id} className="border-b border-slate-50 last:border-0"><td className="p-4"><span className="font-bold text-slate-700 text-sm">{p.method}</span> {p.installments && <span className="ml-1 text-slate-400">({p.installments})</span>}<span className="ml-2 px-2 py-0.5 rounded-md bg-slate-100 text-slate-500 font-bold text-[10px] uppercase tracking-wide">{p.type}</span></td><td className={`p-4 text-right font-mono font-bold text-sm ${styles.amount}`}>{formatCurrency(p.amount)}</td><td className="p-4"><button onClick={() => handleRemovePayment(p.id)} className="text-slate-300 hover:text-red-500 transition-colors p-1.5 hover:bg-red-50 rounded-lg"><Icons.Trash2 className="w-4 h-4"/></button></td></tr>); })}</tbody></table>
                                                        <div className="p-5 bg-slate-50/50 space-y-2 border-t border-slate-100"><div className="flex justify-between items-center"><span className="font-bold text-xs uppercase text-slate-400 tracking-wider">Restante a pagar</span> <span className={remainingToPay > 0 ? "text-red-500 font-mono font-bold text-lg" : "text-slate-300 font-mono font-bold text-lg"}>{formatCurrency(remainingToPay)}</span></div><div className="flex justify-between items-center"><span className="font-bold text-xs uppercase text-slate-400 tracking-wider">Total Recebido</span> <span className="text-emerald-600 font-mono font-black text-xl">{formatCurrency(totalPaid)}</span></div></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex gap-4 pt-4 border-t border-white/50">{editingId && (<button type="button" onClick={resetForm} className="w-1/3 py-5 rounded-2xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 border border-slate-200 transition-all active-scale text-base uppercase tracking-wide">Cancelar</button>)}<button type="submit" className={`flex-1 py-5 rounded-2xl font-black text-white shadow-xl transition-all active-scale text-lg uppercase tracking-wide ${editingId ? 'bg-gradient-to-r from-orange-500 to-orange-600 shadow-orange-500/30 hover:to-orange-700' : 'bg-gradient-to-r from-odoo-600 to-odoo-700 shadow-odoo-500/30 hover:to-odoo-800'}`}>{editingId ? "Atualizar Registro" : "Finalizar Lançamento"}</button></div>
                                        </form>
                                    </div>
                                </div>

                                <div className="space-y-8 mt-12">
                                    <div className="hidden print:block text-center mb-6 border-b-2 border-black pb-2"><h1 className="text-2xl font-bold uppercase">Relatório de Vendas</h1><p className="text-sm">{filterDate ? `Data: ${formatDateBR(filterDate)}` : (searchTerm ? `Filtro: ${searchTerm}` : `Geral - ${new Date().toLocaleDateString('pt-BR')}`)}</p></div>
                                     <div className="glass p-6 rounded-[2rem] shadow-lg border border-white flex flex-col md:flex-row justify-between items-center gap-6 no-print">
                                        <div><p className="text-xs text-slate-400 uppercase font-bold tracking-widest mb-1">Total Listado</p><p className="text-4xl font-black text-slate-800 tracking-tighter">{settings.currency} {formatCurrency(filteredSales.reduce((s, i) => s + (i.amountPaid || i.amount), 0))}</p></div>
                                        <div className="flex gap-3 w-full md:w-auto items-center"><div className="flex flex-1 gap-3"><div className="w-40"><DateInput value={filterDate} onChange={e => setFilterDate(e.target.value)} className="w-full p-3.5 border border-slate-200 rounded-xl text-sm outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 text-slate-600 bg-white font-medium" placeholder="Filtrar Data"/></div><div className="relative flex-1"><Icons.Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" /><input type="text" placeholder="Filtrar por nome, produto..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3.5 bg-white border border-slate-200 rounded-xl outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 text-sm font-medium transition-all" /></div>{(filterDate || searchTerm) && (<button onClick={() => { setFilterDate(''); setSearchTerm(''); }} className="p-3.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition-colors border border-red-100" title="Limpar Filtros"><Icons.Trash2 className="w-5 h-5" /></button>)}</div><button onClick={() => window.print()} className="px-6 py-3.5 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 transition-all shadow-lg shadow-slate-800/20 active-scale text-sm flex items-center gap-2"><Icons.Printer className="w-5 h-5"/> <span className="hidden sm:inline">Imprimir</span></button></div>
                                    </div>
                                    {groupedSales.length > 0 ? (
                                        <div className="space-y-8">
                                            {groupedSales.map(group => (
                                                <div key={group.key} className="space-y-4">
                                                    <div className="flex justify-between items-end px-2 font-bold text-slate-700 tracking-tight border-l-4 border-odoo-500 pl-4 py-1"><h3 className="text-lg">{groupBy === 'date' ? formatDateBR(group.key) : "Registros"}</h3><span className="text-sm bg-white px-3 py-1 rounded-lg border border-slate-100 shadow-sm text-slate-500">Subtotal: <span className="text-slate-800">{formatCurrency(group.total)}</span></span></div>
                                                    <div className="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden overflow-x-auto">
                                                        <table className="w-full text-base"><thead className="bg-slate-50/50 text-slate-400 border-b border-slate-100 font-bold text-[11px] uppercase tracking-widest"><tr><th className="p-5 text-left w-[15%] print-col-cliente pl-8">Cliente</th><th className="p-5 text-left w-[35%] print-col-itens">Itens & Detalhes</th><th className="p-5 text-center w-[10%] print-col-vendedor">Vendedor</th><th className="p-5 text-left w-[25%] print-col-pagamento">Pagamento</th><th className="p-5 text-right w-[10%] print-col-total">Total Pago</th><th className="p-5 text-center no-print w-[5%] pr-8">Ações</th></tr></thead>
                                                            <tbody className="divide-y divide-slate-50">
                                                                {group.items.map(s => (
                                                                    <tr key={s.id} className="hover:bg-slate-50/80 transition-colors group">
                                                                        <td className="p-5 align-top break-words whitespace-normal pl-8"><div className="font-bold text-slate-800 leading-tight mb-1">{s.clientName}</div><div className="text-xs font-mono text-slate-400 bg-slate-100 inline-block px-1.5 py-0.5 rounded">{s.clientCpf}</div></td>
                                                                        <td className="p-5 align-top whitespace-normal"><div className="space-y-2">{(s.items || []).map((i, idx) => (<div key={idx} className="flex justify-between items-start text-sm p-2 rounded-xl border border-transparent hover:border-slate-100 hover:bg-white hover:shadow-sm transition-all flex-wrap sm:flex-nowrap gap-3"><div className="flex-1 min-w-0 leading-snug whitespace-normal"><span className="font-bold text-odoo-600 bg-odoo-50 px-1.5 rounded mr-1.5 text-xs">{i.quantity}x</span> <span className="font-semibold text-slate-700">{i.type} - {i.description}</span><div className="text-[10px] text-slate-400 uppercase tracking-wider mt-1 font-bold flex flex-wrap gap-1">{i.ram_storage && <span>{i.ram_storage} •</span>}{i.color && <span>{i.color} •</span>}{i.imei && <span className="text-slate-500">IMEI: {i.imei} •</span>}<span>{i.financed === 'Sim' ? 'Financiado' : 'À Vista'}</span></div></div><div className="text-right min-w-[90px]"><div className="font-bold text-slate-700">{formatCurrency((i.unitPrice * i.quantity) - i.discount)}</div><div className="text-[10px] text-slate-400 font-medium mb-0.5">Unit: {formatCurrency(i.unitPrice)}</div>{i.discount > 0 && <div className="text-[10px] text-red-400 font-bold">-{formatCurrency(i.discount)}</div>}{(s.category === 'Troca' || s.category === 'Devolução') && (<div className={`text-[9px] font-black uppercase tracking-wider mt-0.5 ${i.unitPrice > 0 ? 'text-green-500' : 'text-red-500'}`}>{i.unitPrice > 0 ? 'Levou' : 'Devolveu'}</div>)}</div></div>))}</div></td>
                                                                        <td className="p-5 align-top text-xs font-bold text-slate-400 uppercase text-center leading-none whitespace-normal tracking-wider pt-7">{s.employeeName}</td>
                                                                        <td className="p-5 align-top whitespace-normal">{(s.category === 'Devolução' || (s.category === 'Troca' && (s.amountPaid || s.amount) < 0)) && (<div className="mb-3 font-bold text-red-600 bg-red-50 border border-red-100 p-2 rounded-lg text-center text-[10px] uppercase tracking-widest shadow-sm">DEVOLUÇÃO</div>)}<div className="space-y-2">{(s.payments || []).map((p, idx) => { let styles = getPaymentStyles(p.type); if (["Devolução Dinheiro", "Devolução Pix", "Devolução Estorno Cartão"].includes(p.method)) { styles = { wrapper: 'bg-red-50 border-red-200 text-red-800', amount: 'text-red-700' }; } return (<div key={idx} className={`flex justify-between text-xs px-3 py-2 rounded-lg border items-center ${styles.wrapper} flex-wrap`}><div className="flex flex-col min-w-0 flex-1 mr-2"><span className="font-bold break-words whitespace-normal leading-tight">{p.method}</span><span className="text-[9px] uppercase font-bold opacity-60 tracking-wider mt-0.5">{p.installments ? `${p.installments} ` : ''}{p.type || 'Integral'}</span></div><span className={`font-mono font-bold whitespace-nowrap ${styles.amount}`}>{formatCurrency(p.amount)}</span></div>); })}</div></td>
                                                                        <td className="p-5 align-top text-right pt-6"><span className="font-black text-slate-800 text-lg whitespace-nowrap bg-slate-100 px-3 py-1 rounded-lg">{formatCurrency(s.amountPaid || s.amount)}</span></td>
                                                                        <td className="p-5 align-top text-center no-print pr-8 pt-6"><div className="flex flex-col items-center gap-2 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0"><button onClick={() => openReceipt(s)} title="Ver Recibo" className="p-2 text-slate-400 hover:text-odoo-600 hover:bg-odoo-50 rounded-lg transition-colors"><Icons.Receipt className="w-5 h-5"/></button>{s.clientPhone && (<button onClick={() => window.open(`https://wa.me/55${s.clientPhone.replace(/\D/g, '')}`, '_blank')} title="WhatsApp" className="p-2 text-slate-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"><Icons.WhatsApp className="w-5 h-5"/></button>)}<button onClick={() => { setPendingEditItem(s); setPendingAuthAction('edit'); setManagerAuthModalOpen(true); }} className="p-2 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded-lg transition-colors"><Icons.Edit className="w-5 h-5"/></button></div></td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            ))}
                                            <div className="flex justify-center items-center gap-6 py-8 no-print"><button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="px-5 py-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 disabled:opacity-50 disabled:hover:bg-white font-bold text-slate-600 transition-all active-scale text-sm shadow-sm">Anterior</button><span className="text-slate-400 font-bold text-xs uppercase tracking-widest bg-white px-4 py-2 rounded-full shadow-sm border border-slate-100">Página {currentPage} de {totalPages}</span><button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="px-5 py-2.5 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 disabled:opacity-50 disabled:hover:bg-white font-bold text-slate-600 transition-all active-scale text-sm shadow-sm">Próxima</button></div>
                                        </div>
                                    ) : (<div className="glass p-20 text-center rounded-[2.5rem] border border-dashed border-slate-300 text-slate-400 flex flex-col items-center"><div className="p-6 bg-slate-50 rounded-full mb-6 shadow-inner"><Icons.Search className="w-12 h-12 opacity-20"/></div><p className="font-bold text-xl text-slate-600 mb-2">Nenhum registro encontrado</p><p className="text-sm">Tente ajustar os filtros de busca ou data.</p></div>)}
                                </div>
                            </>
                        )}
                    </div>
                    {clientDataModalOpen && selectedClientForEdit && (
                        <div className="fixed inset-0 z-[170] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-8 w-full max-w-4xl shadow-2xl animate-in zoom-in-95 duration-300 text-slate-700 relative overflow-hidden max-h-[90vh] flex flex-col border border-white/20">
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-purple-400 to-purple-600"></div>
                                <div className="flex justify-between items-center mb-8 relative z-10 border-b border-slate-100 pb-6 mt-2"><h3 className="font-bold text-3xl text-slate-800 flex items-center gap-4 font-display"><div className="p-3 bg-purple-50 rounded-2xl text-purple-600 shadow-sm"><Icons.FileText className="w-8 h-8"/></div>Dados do Cliente</h3><button onClick={() => setClientDataModalOpen(false)} className="p-3 hover:bg-slate-100 rounded-2xl transition-colors text-slate-400 hover:text-slate-600"><Icons.X className="w-6 h-6"/></button></div>
                                <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar flex-1 relative z-10 pb-4">
                                    <div className="grid grid-cols-1 md:grid-cols-12 gap-5">
                                        <div className="md:col-span-8 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Nome Completo</label><input type="text" value={selectedClientForEdit.name} onChange={e => handleClientDataChange('name', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-4 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">CPF</label><input type="text" value={selectedClientForEdit.cpf} onChange={e => handleClientDataChange('cpf', maskCPF(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm font-mono outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-4 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Telefone</label><input type="text" value={selectedClientForEdit.phone} onChange={e => handleClientDataChange('phone', maskPhone(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-5 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Email</label><input type="email" value={selectedClientForEdit.email} onChange={e => handleClientDataChange('email', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-3 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Nascimento</label><input type="text" value={selectedClientForEdit.dob} onChange={e => handleClientDataChange('dob', maskDateStrict(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" placeholder="dd/mm/aaaa" /></div>
                                        <div className="md:col-span-12 border-t border-slate-100 my-4 relative"><span className="absolute left-1/2 -top-3 -translate-x-1/2 bg-white px-4 text-xs font-bold text-slate-300 uppercase tracking-widest">Endereço</span></div>
                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">CEP</label><input type="text" value={selectedClientForEdit.zip} onChange={e => handleClientDataChange('zip', maskCEP(e.target.value))} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-6 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Logradouro</label><input type="text" value={selectedClientForEdit.address} onChange={e => handleClientDataChange('address', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Nº</label><input type="text" value={selectedClientForEdit.number} onChange={e => handleClientDataChange('number', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-2 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">UF</label><select value={selectedClientForEdit.state} onChange={e => handleClientDataChange('state', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium bg-white"><option value="">UF</option>{UF_LIST.map(uf => <option key={uf} value={uf}>{uf}</option>)}</select></div>
                                        <div className="md:col-span-5 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Bairro</label><input type="text" value={selectedClientForEdit.neighborhood} onChange={e => handleClientDataChange('neighborhood', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                        <div className="md:col-span-7 space-y-1"><label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider ml-1 mb-1 block">Cidade</label><input type="text" value={selectedClientForEdit.city} onChange={e => handleClientDataChange('city', e.target.value)} className="w-full p-4 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-4 focus:ring-purple-100 focus:border-purple-500 transition-all font-medium" /></div>
                                    </div>
                                </div>
                                <div className="mt-6 pt-6 border-t border-slate-100 flex justify-end gap-4 relative z-10"><button onClick={() => setClientDataModalOpen(false)} className="px-8 py-3.5 bg-slate-50 text-slate-600 rounded-2xl font-bold hover:bg-slate-100 transition-all active-scale">Fechar</button><button onClick={confirmClientUpdate} className="px-8 py-3.5 bg-purple-600 text-white rounded-2xl font-bold hover:bg-purple-700 shadow-lg shadow-purple-500/30 transition-all active-scale">Atualizar Dados</button></div>
                            </div>
                        </div>
                    )}
                    {confirmClientUpdateModalOpen && (
                        <div className="fixed inset-0 z-[190] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-10 text-center max-w-sm w-full animate-in zoom-in-95 shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-purple-500"></div><div className="w-20 h-20 bg-purple-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.UserCheck className="w-10 h-10 text-purple-600"/></div><h3 className="font-bold text-2xl mb-4 text-slate-800 font-display">Confirmar Alteração</h3><p className="text-sm text-slate-500 mb-8 leading-relaxed font-medium">Deseja realmente atualizar os dados cadastrais deste cliente?</p>
                                <div className="flex gap-4"><button onClick={() => setConfirmClientUpdateModalOpen(false)} className="flex-1 p-4 bg-slate-50 text-slate-600 rounded-2xl font-bold hover:bg-slate-100 transition-all active-scale">Cancelar</button><button onClick={performClientUpdate} className="flex-1 p-4 bg-purple-600 text-white rounded-2xl font-bold hover:bg-purple-700 shadow-lg shadow-purple-500/30 transition-all active-scale">Confirmar</button></div>
                            </div>
                        </div>
                    )}
                    {receiptModalOpen && currentReceipt && (
                        <div className="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-slate-900/70 backdrop-blur-lg no-print receipt-modal-wrapper animate-in fade-in duration-300" onClick={() => setReceiptModalOpen(false)}>
                            <div className="w-full max-w-[385px] animate-in zoom-in-95 duration-300 receipt-modal-content scale-100" onClick={e => e.stopPropagation()}>
                                <div className="bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-3 flex justify-between items-center mb-4 no-print receipt-actions-bar shadow-xl"><div className="flex gap-2"><button onClick={() => window.print()} title="Imprimir" className="bg-white/10 p-2 rounded-xl text-white hover:bg-white/20 hover:scale-105 transition-all"><Icons.Printer className="w-5 h-5" /></button><button onClick={handleExportReceiptPDF} title="Exportar PDF" className="bg-white/10 p-2 rounded-xl text-white hover:bg-red-500/20 hover:text-red-200 hover:scale-105 transition-all"><Icons.FilePdf className="w-5 h-5" /></button></div><button onClick={() => setReceiptModalOpen(false)} title="Fechar" className="text-white hover:bg-white/10 p-2 rounded-xl transition-all hover:rotate-90"><Icons.X className="w-5 h-5" /></button></div>
                                <div id="receipt-paper" className="bg-white receipt-paper rounded-2xl overflow-hidden shadow-2xl font-receipt text-slate-900 text-[13px] leading-snug relative">
                                    <div className="bg-slate-900 text-white p-8 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-full opacity-10" style={{backgroundImage: 'radial-gradient(#ffffff 1px, transparent 1px)', backgroundSize: '8px 8px'}}></div><div className="relative z-10"><h2 className="text-3xl font-black uppercase tracking-tighter mb-1">MIPLACE</h2><p className="text-[10px] uppercase tracking-[0.3em] opacity-60 mb-5">Dompedro • Tecnologia</p><div className="w-10 h-1 bg-odoo-500 mx-auto rounded-full mb-5"></div><p className="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1 border border-slate-700 inline-block px-3 py-1 rounded-full bg-slate-800">Cupom Não Fiscal</p><div className="flex justify-center gap-4 text-[11px] font-bold opacity-80 mt-3 font-mono"><span>{formatDateBR(currentReceipt.date)}</span><span className="opacity-30">|</span><span>{currentReceipt.timestamp ? new Date(currentReceipt.timestamp).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) : '00:00'}</span></div></div></div>
                                    <div className="p-6 relative">
                                        <div className="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiNmMzZjNzQiLz48L3N2Zz4=')] opacity-30 pointer-events-none"></div>
                                        <div className="mb-6 space-y-2 text-[12px] bg-slate-50 p-4 rounded-xl border border-slate-200 relative z-10"><div className="flex justify-between items-baseline"><span className="font-bold text-slate-400 uppercase text-[10px] tracking-wider">Cliente</span> <span className="font-bold text-right break-words max-w-[150px] text-sm">{currentReceipt.clientName}</span></div><div className="flex justify-between items-baseline"><span className="font-bold text-slate-400 uppercase text-[10px] tracking-wider">CPF</span> <span className="font-mono">{currentReceipt.clientCpf || '---'}</span></div><div className="flex justify-between items-baseline"><span className="font-bold text-slate-400 uppercase text-[10px] tracking-wider">Contato</span> <span className="font-mono">{currentReceipt.clientPhone || '---'}</span></div></div>
                                        <div className="border-t-2 border-dashed border-slate-200 py-5 space-y-5 relative z-10">{(currentReceipt.items || []).sort((a,b) => { if(currentReceipt.category === 'Troca') return a.unitPrice - b.unitPrice; return 0; }).map((it, idx) => (<div key={idx} className="relative"><div className="flex justify-between items-start font-bold text-sm"><div className="flex gap-2"><span className="text-slate-400 font-mono">{it.quantity}x</span><span className="uppercase leading-tight">{it.description}</span></div><span className="font-mono whitespace-nowrap ml-2">{formatCurrency((it.unitPrice * it.quantity) - it.discount)}</span></div><div className="text-[10px] text-slate-400 pl-6 uppercase tracking-tight font-medium mt-0.5">{it.type} • {it.ram_storage} • {it.color}</div>{it.discount > 0 && <div className="text-[10px] text-red-500 pl-6 font-bold bg-red-50 inline-block rounded px-1 ml-6 mt-1">Desc: -{formatCurrency(it.discount)}</div>}</div>))}</div>
                                        <div className="border-t-2 border-slate-800 pt-5 mt-2 mb-6 relative z-10"><div className="flex justify-between items-end mb-2"><span className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">Total a Pagar</span><span className="text-3xl font-black tracking-tighter">R$ {formatCurrency(currentReceipt.amount)}</span></div></div>
                                        <div className="space-y-2 text-[11px] mb-8 relative z-10 bg-slate-50 p-3 rounded-lg border border-slate-100">{(currentReceipt.payments || []).map((p, idx) => (<div key={idx} className="flex justify-between uppercase border-b border-slate-200 pb-1 last:border-0 last:pb-0"><span className="font-bold text-slate-500">{p.method} <span className="text-[9px] opacity-60 ml-1">{p.installments}</span></span><span className="font-mono font-bold">{formatCurrency(p.amount)}</span></div>))}{currentReceipt.change > 0 && (<div className="flex justify-between uppercase pt-2 mt-1 border-t-2 border-slate-200"><span className="font-black text-slate-400">Troco</span><span className="font-mono font-bold text-slate-700">{formatCurrency(currentReceipt.change)}</span></div>)}</div>
                                        <div className="text-center space-y-5 relative z-10"><div className="bg-slate-800 text-white rounded-xl p-4 shadow-lg"><p className="text-[9px] font-bold uppercase mb-1 opacity-60 tracking-widest">WhatsApp / Suporte</p><p className="text-xl font-black tracking-wider font-mono">(19) 99497-5131</p></div><div className="text-[9px] uppercase text-slate-400 tracking-widest pt-2 font-bold"><p className="mb-1.5">Vendedor: {currentReceipt.employeeName}</p><p>Obrigado pela preferência!</p></div><div className="w-24 h-1 bg-slate-200 mx-auto rounded-full"></div></div>
                                    </div>
                                    <div className="h-4 bg-slate-100" style={{background: 'linear-gradient(45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, #ffffff 33.333%, #ffffff 66.667%, transparent 66.667%)', backgroundSize: '12px 24px', backgroundPosition: '0 -12px', transform: 'rotate(180deg)'}}></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {isBackupOpen && (
                        <div className="fixed inset-0 z-[170] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-10 max-w-md w-full shadow-2xl animate-in zoom-in-95 duration-300 text-slate-700 relative overflow-hidden border border-white/20">
                                <div className="flex justify-between items-center mb-8 relative z-10"><h3 className="font-bold text-2xl text-slate-800 font-display">Backup do Sistema</h3><button onClick={() => setIsBackupOpen(false)} className="p-3 hover:bg-slate-100 rounded-2xl transition-colors"><Icons.X className="w-6 h-6 text-slate-400"/></button></div>
                                <div className="space-y-5 relative z-10">
                                    <div className="p-6 bg-blue-50/50 rounded-3xl border border-blue-100 hover:shadow-lg transition-all group duration-300 hover:-translate-y-1">
                                        <div className="flex items-center gap-4 mb-3">
                                            <div className="p-3 bg-blue-100 text-blue-600 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Download className="w-6 h-6"/></div>
                                            <h4 className="font-bold text-lg text-blue-900">Salvar Backup</h4>
                                        </div>
                                        <p className="text-xs text-blue-600/80 mb-5 pl-14 leading-relaxed">Gere um arquivo de segurança (.json) contendo todos os dados de vendas e clientes.</p>
                                        <div className="flex gap-2">
                                            <button onClick={handleExportBackup} className="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition-all active-scale shadow-lg shadow-blue-500/20 text-sm uppercase tracking-wide">Baixar Arquivo</button>
                                            <button onClick={handleSaveToCloud} className="flex-1 py-4 bg-sky-500 text-white rounded-2xl font-bold hover:bg-sky-600 transition-all active-scale shadow-lg shadow-sky-500/20 text-sm uppercase tracking-wide flex items-center justify-center gap-2"><Icons.CloudUpload className="w-5 h-5"/> Nuvem</button>
                                        </div>
                                    </div>
                                    <div className="p-6 bg-orange-50/50 rounded-3xl border border-orange-100 hover:shadow-lg transition-all group duration-300 hover:-translate-y-1"><div className="flex items-center gap-4 mb-3"><div className="p-3 bg-orange-100 text-orange-600 rounded-2xl group-hover:scale-110 transition-transform"><Icons.Upload className="w-6 h-6"/></div><h4 className="font-bold text-lg text-orange-900">Importar Backup</h4></div><p className="text-xs text-orange-800/80 mb-5 pl-14 leading-relaxed">Restaure dados de um arquivo salvo anteriormente. Isso unificará com os dados atuais (Na nuvem).</p><input type="file" accept=".json" multiple onChange={handleImportBackup} ref={fileInputInternalRef} className="hidden" /><button onClick={() => fileInputInternalRef.current.click()} className="w-full py-4 bg-orange-500 text-white rounded-2xl font-bold hover:bg-orange-600 transition-all active-scale shadow-lg shadow-orange-500/20 text-sm uppercase tracking-wide">Selecionar Arquivos</button></div>
                                    <div className="p-6 bg-red-50/50 rounded-3xl border border-red-100 mt-8 hover:shadow-lg transition-all group"><div className="flex items-center gap-4 mb-2"><div className="p-2 bg-red-100 text-red-600 rounded-xl group-hover:rotate-12 transition-transform"><Icons.AlertTriangle className="w-5 h-5"/></div><h4 className="font-bold text-red-900 text-sm">Zona de Perigo</h4></div><p className="text-[10px] text-red-700 mb-4 pl-12 font-medium">Resetar o sistema LOCAL (cache) para o estado inicial.</p><button onClick={triggerFactoryReset} className="w-full py-3 bg-white border border-red-200 text-red-600 rounded-2xl font-bold hover:bg-red-50 transition-all active-scale text-xs uppercase tracking-wide">Limpar Cache Local</button></div>
                                </div>
                                <div className="mt-10 pt-6 border-t border-slate-100 text-center text-[10px] text-slate-300 uppercase font-black tracking-[0.3em]">Miplace 2026 • v2.0</div>
                            </div>
                        </div>
                    )}
                    {logoutModalOpen && (
                        <div className="fixed inset-0 z-[180] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-10 text-center max-w-sm w-full animate-in zoom-in-95 shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-red-500"></div><div className="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.LogOut className="w-10 h-10 text-red-500"/></div><h3 className="font-bold text-2xl mb-3 text-slate-800 font-display">Sair do Sistema?</h3><p className="text-sm text-slate-500 mb-8 leading-relaxed font-medium">Recomendamos <b>salvar um backup</b> antes de trocar de vendedor para evitar perda de dados.</p>
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <button onClick={handleExportBackup} className="flex-1 p-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition-all active-scale uppercase tracking-wide text-[10px]">Baixar & Sair</button>
                                        <button onClick={() => { handleSaveToCloud(); setTimeout(() => setLogoutModalOpen(false), 1500); }} className="flex-1 p-4 bg-sky-500 text-white rounded-2xl font-bold hover:bg-sky-600 shadow-lg shadow-sky-500/30 transition-all active-scale uppercase tracking-wide text-[10px] flex items-center justify-center gap-1"><Icons.CloudUpload className="w-4 h-4"/> Salvar Nuvem</button>
                                    </div>
                                    <div className="flex gap-3"><button onClick={() => setLogoutModalOpen(false)} className="flex-1 p-4 bg-slate-50 text-slate-600 rounded-2xl font-bold hover:bg-slate-100 transition-colors active-scale text-xs uppercase tracking-wide">Cancelar</button><button onClick={() => { setIsLoggedIn(false); setLogoutModalOpen(false); }} className="flex-1 p-4 bg-white border border-red-100 text-red-500 rounded-2xl font-bold hover:bg-red-50 transition-colors active-scale text-xs uppercase tracking-wide">Sair sem Salvar</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {confirmSaleModalOpen && (
                        <div className="fixed inset-0 z-[190] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-10 text-center max-w-sm w-full animate-in zoom-in-95 shadow-2xl border-4 border-green-50 relative overflow-hidden">
                                <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse-slow shadow-inner"><Icons.Check className="w-12 h-12 text-green-600"/></div><h3 className="font-bold text-3xl mb-3 text-slate-800 font-display">Confirmar Venda</h3><p className="text-sm text-slate-500 mb-8 px-4 font-medium">Você confirma o recebimento do pagamento e o lançamento dos itens?</p>
                                <div className="flex gap-4"><button onClick={() => setConfirmSaleModalOpen(false)} className="flex-1 p-4 bg-slate-50 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors active-scale">Voltar</button><button onClick={() => { setConfirmSaleModalOpen(false); performSave(); }} className="flex-1 p-4 bg-green-600 text-white rounded-2xl font-bold hover:bg-green-700 shadow-lg shadow-green-500/30 transition-all active-scale">Confirmar!</button></div>
                            </div>
                        </div>
                    )}
                    {dateLockModalOpen && (
                        <div className="fixed inset-0 z-[160] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300">
                            <div className="bg-white rounded-[2.5rem] p-10 text-center max-w-md w-full animate-in zoom-in-95 shadow-2xl relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-2 bg-slate-800"></div><div className="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.Lock className="w-10 h-10 text-slate-600"/></div><h3 className="font-bold text-2xl mb-2 text-slate-800 font-display">Data Bloqueada</h3><p className="text-sm text-slate-500 mb-8 font-medium">Insira a senha gerencial para alterar a data.</p><input type="password" value={dateLockPassword} onChange={e => setDateLockPassword(e.target.value)} className="w-full p-5 border border-slate-200 rounded-2xl text-center mb-8 font-bold outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all text-xl placeholder:font-normal bg-slate-50 focus:bg-white" placeholder="Senha" autoFocus /><div className="flex gap-4"><button onClick={() => { setDateLockModalOpen(false); setDateLockPassword(''); }} className="flex-1 p-4 bg-slate-50 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors active-scale">Cancelar</button><button onClick={async () => { if (dateLockPassword === MANAGER_PASSWORD) { setIsDateLocked(false); setDateLockModalOpen(false); setDateLockPassword(''); showToast("Data liberada!"); } else showToast("Senha incorreta", "error"); }} className="flex-1 p-4 bg-slate-800 text-white rounded-2xl font-bold hover:bg-slate-900 shadow-lg shadow-slate-500/30 transition-all active-scale">Liberar</button></div>
                            </div>
                        </div>
                    )}
                    {clientSearchModalOpen && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm no-print animate-in fade-in duration-200">
                            <div className="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl animate-in zoom-in-95 overflow-hidden flex flex-col max-h-[80vh]">
                                <div className="p-6 border-b border-slate-100 flex justify-between font-bold items-center text-xl bg-slate-50/50 font-display"><h3>Selecionar Cliente</h3><button onClick={() => setClientSearchModalOpen(false)} className="p-3 hover:bg-slate-100 rounded-2xl transition-colors"><Icons.X className="w-6 h-6 text-slate-400"/></button></div>
                                <div className="p-6"><div className="relative group"><Icons.Search className="absolute left-5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 group-hover:text-odoo-500 transition-colors"/><input type="text" placeholder="Digite Nome ou CPF..." value={clientSearchTerm} onChange={e => setClientSearchTerm(e.target.value)} className="w-full pl-14 pr-5 py-5 border border-slate-200 rounded-2xl outline-none focus:ring-4 focus:ring-odoo-100 focus:border-odoo-500 transition-all text-lg shadow-sm font-medium" autoFocus /></div></div>
                                <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                    {filteredClients.map(c => (<div key={c.id} onClick={() => { fillClientData(c); setClientSearchModalOpen(false); }} className="p-5 mx-2 mb-3 border border-slate-100 rounded-2xl hover:bg-odoo-50 hover:border-odoo-200 cursor-pointer flex justify-between items-center transition-all group shadow-sm hover:shadow-md hover:-translate-y-0.5 duration-300"><div><div className="font-bold text-slate-700 text-lg group-hover:text-odoo-800">{c.name}</div><div className="text-sm text-slate-400 font-mono group-hover:text-odoo-500 bg-slate-50 inline-block px-2 py-0.5 rounded mt-1">{c.cpf}</div></div><div className="p-3 bg-slate-100 rounded-xl group-hover:bg-white text-slate-400 group-hover:text-odoo-500 transition-colors shadow-sm"><Icons.Plus className="w-6 h-6"/></div></div>))}
                                    {filteredClients.length === 0 && <div className="p-10 text-center text-slate-400 text-sm italic">Nenhum cliente encontrado.</div>}
                                </div>
                            </div>
                        </div>
                    )}
                    {clientHistoryModalOpen && selectedClientHistory && (
                        <div className="fixed inset-0 z-[150] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300" onClick={() => setClientHistoryModalOpen(false)}>
                            <div className="bg-white rounded-[3rem] w-full max-w-4xl max-h-[85vh] overflow-hidden shadow-2xl flex flex-col animate-in zoom-in-95 duration-300 border border-white/20" onClick={e => e.stopPropagation()}>
                                <div className="p-8 border-b border-slate-100 bg-white/80 backdrop-blur-md flex justify-between items-center sticky top-0 z-10"><div><h3 className="font-bold text-2xl text-slate-800 flex items-center gap-3 font-display"><div className="p-3 bg-slate-100 rounded-2xl shadow-sm text-slate-600"><Icons.History className="w-6 h-6"/></div> Histórico de Compras</h3><p className="text-base text-slate-500 mt-2 ml-2 font-medium">{(selectedClientHistory.client.name || 'Cliente')} • <span className="font-mono text-sm">{selectedClientHistory.client.cpf}</span></p></div><button onClick={() => setClientHistoryModalOpen(false)} className="p-4 hover:bg-slate-100 rounded-2xl transition-colors"><Icons.X className="w-6 h-6 text-slate-400"/></button></div>
                                <div className="flex-1 overflow-y-auto p-8 bg-slate-50/50 custom-scrollbar">
                                    {selectedClientHistory.history.length === 0 ? (<div className="text-center py-20"><div className="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-300 shadow-inner"><Icons.History className="w-12 h-12"/></div><p className="text-slate-400 font-bold text-lg">Nenhuma compra registrada.</p></div>) : (
                                            <div className="space-y-6">
                                                {selectedClientHistory.history.map(sale => (
                                                    <div key={sale.id} className="bg-white rounded-[2rem] shadow-sm border border-slate-100 p-8 flex flex-col md:flex-row gap-8 hover:shadow-xl transition-all hover:-translate-y-1 duration-300 group">
                                                        <div className="md:w-36 flex flex-col justify-center items-center bg-slate-50 rounded-3xl p-6 border border-slate-100 group-hover:bg-odoo-50 group-hover:border-odoo-100 transition-colors"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1 group-hover:text-odoo-400">Data</span><span className="text-3xl font-black text-slate-800 group-hover:text-odoo-700">{formatDateBR(sale.date).split('/')[0]}</span><span className="text-sm font-bold text-slate-500 uppercase">{new Date(sale.date).toLocaleString('default', { month: 'short' })}</span><span className="text-xs font-bold text-slate-300 mt-1">{formatDateBR(sale.date).split('/')[2]}</span></div>
                                                        <div className="flex-1"><span className="text-xs font-bold text-slate-400 uppercase mb-4 block tracking-widest pl-1">Produtos</span><div className="space-y-3">{(sale.items || []).map((item, idx) => (<div key={idx} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100/50 hover:bg-white hover:shadow-sm transition-all"><div><span className="font-bold text-sm text-odoo-600 bg-odoo-50 px-2 py-1 rounded-lg mr-2 border border-odoo-100">{item.quantity}x</span> <span className="text-base font-bold text-slate-700">{item.description}</span> <div className="text-xs text-slate-400 ml-1 mt-1 font-medium pl-9 uppercase tracking-wide">{item.ram_storage} • {item.color}</div></div><div className="text-right font-bold text-base text-slate-700 font-mono">{formatCurrency((item.unitPrice * item.quantity) - item.discount)}</div></div>))}</div></div>
                                                        <div className="md:w-64 flex flex-col justify-between border-l border-slate-100 pl-8 border-dashed"><div><span className="text-xs font-bold text-slate-400 uppercase mb-3 block tracking-widest">Pagamento</span><div className="space-y-2">{(sale.payments || []).map((p, idx) => (<div key={idx} className="flex justify-between text-xs font-bold text-slate-600 uppercase"><span>{p.method}</span><span className="font-mono">{formatCurrency(p.amount)}</span></div>))}</div></div><div className="mt-6 pt-6 border-t border-slate-100 flex justify-between items-center"><span className="text-xs font-black text-slate-400 uppercase tracking-wider">Total</span><span className="text-2xl font-black text-slate-800">{formatCurrency(sale.amountPaid || sale.amount)}</span></div><button onClick={() => openReceipt(sale)} className="w-full mt-4 py-3 bg-slate-800 text-white text-xs font-bold rounded-xl hover:bg-slate-900 transition-all shadow-lg shadow-slate-500/20 active:scale-95 uppercase tracking-wide">Ver Recibo</button></div>
                                                    </div>
                                                ))}
                                            </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    {managerAuthModalOpen && (
                        <div className="fixed inset-0 z-[180] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md no-print animate-in fade-in duration-300" onClick={() => setManagerAuthModalOpen(false)}>
                            <div className="bg-white rounded-[2.5rem] p-10 text-center max-w-sm w-full animate-in zoom-in-95 shadow-2xl relative overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="absolute top-0 left-0 w-full h-2 bg-red-500"></div><div className="w-24 h-24 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner"><Icons.Key className="w-10 h-10 text-red-500"/></div><h3 className="font-bold text-2xl mb-3 text-slate-800 font-display">Acesso Restrito</h3>
                                <p className="text-sm text-slate-500 mb-8 leading-relaxed font-medium">
                                    {pendingAuthAction === 'reset' ? 'Você está prestes a APAGAR todos os dados. Insira a senha.' : 
                                     pendingAuthAction === 'edit' ? 'Autorização necessária para editar o lançamento.' : 
                                     pendingAuthAction === 'delete' ? 'Tem certeza que deseja excluir? Esta ação é irreversível.' :
                                     pendingAuthAction === 'update_client' ? 'Confirme a senha gerencial para atualizar o cadastro.' :
                                     'Divergência de valores. Insira a senha para forçar o lançamento.'}
                                </p>
                                <input type="password" value={managerPassword} onChange={e => setManagerPassword(e.target.value)} className="w-full p-5 border border-slate-200 rounded-2xl text-center mb-8 font-bold outline-none focus:ring-4 focus:ring-red-100 focus:border-red-500 transition-all text-xl placeholder:font-normal bg-slate-50 focus:bg-white" placeholder="Senha Gerencial" autoFocus />
                                <div className="flex gap-4"><button onClick={() => setManagerAuthModalOpen(false)} className="flex-1 p-4 bg-slate-50 rounded-2xl font-bold text-slate-600 hover:bg-slate-100 transition-colors active-scale">Cancelar</button><button onClick={handleManagerAuth} className="flex-1 p-4 bg-red-600 text-white rounded-2xl font-bold hover:bg-red-700 shadow-lg shadow-red-500/30 transition-all active-scale">Autorizar</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>